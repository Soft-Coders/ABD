--------------------------------------------------------
-- Archivo creado  - lunes-junio-06-2022   
--------------------------------------------------------
DROP VIEW "FINTECH"."V_COTIZACIONES";
DROP VIEW "FINTECH"."V_PAGOS_PENDIENTES";
DROP VIEW "FINTECH"."V_SALDOS";
DROP VIEW "FINTECH"."V_TARJETA_MENSUAL";
DROP TABLE "FINTECH"."AUTORIZACION" cascade constraints;
DROP TABLE "FINTECH"."CLIENTE" cascade constraints;
DROP TABLE "FINTECH"."COTIZACION_EXT" cascade constraints;
DROP TABLE "FINTECH"."CUENTA" cascade constraints;
DROP TABLE "FINTECH"."CUENTA_FINTECH" cascade constraints;
DROP TABLE "FINTECH"."CUENTA_REFERENCIA" cascade constraints;
DROP TABLE "FINTECH"."DEPOSITAR_EN" cascade constraints;
DROP TABLE "FINTECH"."DIVISA" cascade constraints;
DROP TABLE "FINTECH"."EMPRESA" cascade constraints;
DROP TABLE "FINTECH"."INDIVIDUAL" cascade constraints;
DROP TABLE "FINTECH"."MOVIMIENTOS" cascade constraints;
DROP TABLE "FINTECH"."PERSONA_AUTORIZADA" cascade constraints;
DROP TABLE "FINTECH"."POOLED_ACCOUNT" cascade constraints;
DROP TABLE "FINTECH"."SEGREGADA" cascade constraints;
DROP TABLE "FINTECH"."TARJETAS" cascade constraints;
DROP TABLE "FINTECH"."TRANSACCION" cascade constraints;
DROP TABLE "FINTECH"."VM_COTIZA" cascade constraints;
DROP SEQUENCE "FINTECH"."CUENTA_CUENTA_ID_SEQ";
DROP SEQUENCE "FINTECH"."SQ_CLIENTE";
DROP SEQUENCE "FINTECH"."SQ_CUENTA";
DROP SEQUENCE "FINTECH"."SQ_PERSONA";
DROP SEQUENCE "FINTECH"."SQ_TRANSACCION";
DROP MATERIALIZED VIEW "FINTECH"."VM_COTIZA";
DROP PROCEDURE "FINTECH"."P_CAMBIOEURO";
DROP PROCEDURE "FINTECH"."P_COBRO";
DROP PACKAGE "FINTECH"."PK_GESTION_CLIENTES";
DROP PACKAGE "FINTECH"."PK_GESTION_CUENTAS";
DROP PACKAGE "FINTECH"."PK_OPERATIVA";
DROP PACKAGE BODY "FINTECH"."PK_GESTION_CLIENTES";
DROP PACKAGE BODY "FINTECH"."PK_GESTION_CUENTAS";
DROP PACKAGE BODY "FINTECH"."PK_OPERATIVA";
DROP FUNCTION "FINTECH"."F_COMPRUEBA_SEGREGADA";
DROP FUNCTION "FINTECH"."F_SALDO_REFERENCIA";
DROP SYNONYM "FINTECH"."COTIZACION";
--------------------------------------------------------
--  DDL for View V_COTIZACIONES
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "FINTECH"."V_COTIZACIONES" ("ABREVIATURA", "NOMBRE", "SIMBOLO", "CAMBIOEURO", "FECHA") AS 
  select d.abreviatura, d.nombre, d.simbolo,
to_number( c.valor_en_euros) cambioeuro, to_date(fecha, 'dd/mm/yyyy') fecha
from cotizacion_ext c join divisa d on  c.nombre = d.nombre
where (d.nombre,to_date (fecha,'dd/mm/yyyy')) in (select nombre, max (to_date
(fecha,'dd/mm/yyyy')) from cotizacion_ext group by nombre)
;
--------------------------------------------------------
--  DDL for View V_PAGOS_PENDIENTES
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "FINTECH"."V_PAGOS_PENDIENTES" ("IDENTIFICACION", "NUMERO_TARJETA", "PENDIENTES", "ABREVIATURA") AS 
  (SELECT C.IDENTIFICACION, T.NUMERO, M.ESTADO, D.ABREVIATURA
    FROM CLIENTE C, TARJETAS T, MOVIMIENTOS M, DIVISA D
    WHERE
        C.ID = T.CLIENTE_ID AND
        T.NUMERO = M.NUMERO_TARJETA AND
        M.DIVISA = D.ABREVIATURA AND
        M.ESTADO = 'PENDIENTES')
;
--------------------------------------------------------
--  DDL for View V_SALDOS
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "FINTECH"."V_SALDOS" ("IDENTIFICACION", "IBAN", "SALDO", "ABREVIATURA", "CAMBIO_EURO") AS 
  SELECT cliente.identificacion, cuenta.iban, depositar_en.saldo, divisa.abreviatura, divisa.cambio_euro
    FROM cliente 
    JOIN cuenta_fintech ON cliente.id = cuenta_fintech.cliente_id
    JOIN cuenta ON cuenta_fintech.cuenta_cuenta_id = cuenta.cuenta_id
    JOIN pooled_account ON cuenta_fintech.cuenta_cuenta_id = pooled_account.cuenta_fintech_id
    JOIN depositar_en ON pooled_account.cuenta_fintech_id = depositar_en.pool_id
    JOIN cuenta_referencia ON depositar_en.cuenta_ref_id = cuenta_referencia.cuenta_cuenta_id
    JOIN divisa ON cuenta_referencia.divisa_abreviatura = divisa.abreviatura
    
    UNION ALL 
    
    SELECT cliente.identificacion, cuenta.iban, cuenta_referencia.saldo, divisa.abreviatura, divisa.cambio_euro
    FROM cliente 
    JOIN cuenta_fintech ON cliente.id = cuenta_fintech.cliente_id
    JOIN cuenta ON cuenta_fintech.cuenta_cuenta_id = cuenta.cuenta_id
    JOIN segregada ON cuenta_fintech.cuenta_cuenta_id = segregada.cuenta_fintech_id
    JOIN cuenta_referencia ON segregada.cuenta_ref_id = cuenta_referencia.cuenta_cuenta_id
    JOIN divisa ON cuenta_referencia.divisa_abreviatura = divisa.abreviatura
;
--------------------------------------------------------
--  DDL for View V_TARJETA_MENSUAL
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "FINTECH"."V_TARJETA_MENSUAL" ("IDENTIFICACION", "NUMERO_TARJETA", "GASTO", "ABREVIATURA") AS 
  (SELECT C.IDENTIFICACION, T.NUMERO, SUM(M.CANTIDAD), D.ABREVIATURA  
    FROM CLIENTE C, TARJETAS T, MOVIMIENTOS M, DIVISA D
    WHERE
        C.ID = T.CLIENTE_ID AND
        T.NUMERO = M.NUMERO_TARJETA AND
        M.DIVISA = D.ABREVIATURA
    GROUP BY D.ABREVIATURA,C.IDENTIFICACION, T.NUMERO)
;
--------------------------------------------------------
--  DDL for Table AUTORIZACION
--------------------------------------------------------

  CREATE TABLE "FINTECH"."AUTORIZACION" 
   (	"TIPO" VARCHAR2(20 BYTE), 
	"PERSONA_AUTORIZADA_ID" VARCHAR2(20 BYTE), 
	"EMPRESA_ID" VARCHAR2(20 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table CLIENTE
--------------------------------------------------------

  CREATE TABLE "FINTECH"."CLIENTE" 
   (	"ID" VARCHAR2(20 BYTE), 
	"IDENTIFICACION" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1' NO SALT , 
	"TIPO_CLIENTE" VARCHAR2(20 BYTE), 
	"ESTADO" VARCHAR2(20 BYTE), 
	"FECHA_ALTA" DATE, 
	"FECHA_BAJA" DATE, 
	"DIRECCION" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"CIUDAD" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"CODIGO_POSTAL" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"PAIS" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1'
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table COTIZACION_EXT
--------------------------------------------------------

  CREATE TABLE "FINTECH"."COTIZACION_EXT" 
   (	"NOMBRE" VARCHAR2(30 BYTE), 
	"FECHA" DATE, 
	"VALOR1EURO" NUMBER(10,0), 
	"VARIACION_PORC" NUMBER(5,0), 
	"VARIACION_MES" NUMBER(5,0), 
	"VARIACION_ANIO" NUMBER(5,0), 
	"VALOR_EN_EUROS" FLOAT(10)
   ) 
   ORGANIZATION EXTERNAL 
    ( TYPE ORACLE_LOADER
      DEFAULT DIRECTORY "DIRECTORIO_EXT"
      ACCESS PARAMETERS
      ( RECORDS DELIMITED BY NEWLINE
SKIP 1
CHARACTERSET WE8ISO8859P1
FIELDS TERMINATED BY ';'    )
      LOCATION
       ( 'cotizacion.csv'
       )
    );
--------------------------------------------------------
--  DDL for Table CUENTA
--------------------------------------------------------

  CREATE TABLE "FINTECH"."CUENTA" 
   (	"CUENTA_ID" NUMBER, 
	"IBAN" VARCHAR2(20 BYTE), 
	"SWIFT" VARCHAR2(20 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table CUENTA_FINTECH
--------------------------------------------------------

  CREATE TABLE "FINTECH"."CUENTA_FINTECH" 
   (	"CUENTA_CUENTA_ID" NUMBER, 
	"CLIENTE_ID" VARCHAR2(20 BYTE), 
	"ESTADO" VARCHAR2(20 BYTE), 
	"FECHA_APERTURA" DATE, 
	"FECHA_CIERRE" DATE, 
	"CLASIFICACION" VARCHAR2(20 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table CUENTA_REFERENCIA
--------------------------------------------------------

  CREATE TABLE "FINTECH"."CUENTA_REFERENCIA" 
   (	"CUENTA_CUENTA_ID" NUMBER, 
	"NOMBRE_BANCO" VARCHAR2(20 BYTE), 
	"SUCURSAL" VARCHAR2(20 BYTE), 
	"PAIS" VARCHAR2(20 BYTE), 
	"SALDO" NUMBER(12,0), 
	"FECHA_APERTURA" DATE, 
	"ESTADO" VARCHAR2(20 BYTE), 
	"DIVISA_ABREVIATURA" VARCHAR2(20 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table DEPOSITAR_EN
--------------------------------------------------------

  CREATE TABLE "FINTECH"."DEPOSITAR_EN" 
   (	"SALDO" NUMBER(12,0), 
	"CUENTA_REF_ID" NUMBER, 
	"POOL_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table DIVISA
--------------------------------------------------------

  CREATE TABLE "FINTECH"."DIVISA" 
   (	"ABREVIATURA" VARCHAR2(20 BYTE), 
	"NOMBRE" VARCHAR2(30 BYTE), 
	"SIMBOLO" NVARCHAR2(5), 
	"CAMBIO_EURO" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table EMPRESA
--------------------------------------------------------

  CREATE TABLE "FINTECH"."EMPRESA" 
   (	"CLIENTE_ID" VARCHAR2(20 BYTE), 
	"RAZON_SOCIAL" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1'
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table INDIVIDUAL
--------------------------------------------------------

  CREATE TABLE "FINTECH"."INDIVIDUAL" 
   (	"CLIENTE_ID" VARCHAR2(20 BYTE), 
	"NOMBRE" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"APELLIDO" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"FECHA_NACIMIENTO" DATE ENCRYPT USING 'AES192' 'SHA-1'
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table MOVIMIENTOS
--------------------------------------------------------

  CREATE TABLE "FINTECH"."MOVIMIENTOS" 
   (	"NUMERO" VARCHAR2(20 BYTE), 
	"NUMERO_TARJETA" NUMBER(16,0), 
	"FECHA" DATE, 
	"CANTIDAD" NUMBER(9,0), 
	"ESTADO" VARCHAR2(20 BYTE), 
	"MODO" VARCHAR2(20 BYTE), 
	"TIPO_EMISOR" VARCHAR2(20 BYTE), 
	"DIVISA" VARCHAR2(20 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table PERSONA_AUTORIZADA
--------------------------------------------------------

  CREATE TABLE "FINTECH"."PERSONA_AUTORIZADA" 
   (	"ID" VARCHAR2(20 BYTE), 
	"IDENTIFICACION" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1' NO SALT , 
	"NOMBRE" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"APELLIDOS" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"DIRECCION" VARCHAR2(30 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"FECHA_NACIMIENTO" DATE ENCRYPT USING 'AES192' 'SHA-1', 
	"FECHA_INICIO" DATE, 
	"ESTADO" VARCHAR2(20 BYTE), 
	"FECHA_FIN" DATE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table POOLED_ACCOUNT
--------------------------------------------------------

  CREATE TABLE "FINTECH"."POOLED_ACCOUNT" 
   (	"CUENTA_FINTECH_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table SEGREGADA
--------------------------------------------------------

  CREATE TABLE "FINTECH"."SEGREGADA" 
   (	"CUENTA_FINTECH_ID" NUMBER, 
	"COMISION" VARCHAR2(20 BYTE), 
	"CUENTA_REF_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table TARJETAS
--------------------------------------------------------

  CREATE TABLE "FINTECH"."TARJETAS" 
   (	"NUMERO" NUMBER(16,0), 
	"NOMBRE_TITULAR" VARCHAR2(20 BYTE) ENCRYPT USING 'AES192' 'SHA-1', 
	"CVV" NUMBER(3,0) ENCRYPT USING 'AES192' 'SHA-1', 
	"MARCA" VARCHAR2(20 BYTE), 
	"FECHA_CAD" DATE ENCRYPT USING 'AES192' 'SHA-1', 
	"CLIENTE_ID" VARCHAR2(20 BYTE), 
	"CUENTA_FINTECH_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Table TRANSACCION
--------------------------------------------------------

  CREATE TABLE "FINTECH"."TRANSACCION" 
   (	"ID" VARCHAR2(20 BYTE), 
	"FECHA_INSTRUCCION" DATE, 
	"CANTIDAD" NUMBER(9,0) ENCRYPT USING 'AES192' 'SHA-1', 
	"FECHA_EJECUCION" DATE, 
	"TIPO" VARCHAR2(20 BYTE), 
	"COMISION" NUMBER(8,0) ENCRYPT USING 'AES192' 'SHA-1', 
	"INTERNACIONAL" VARCHAR2(20 BYTE), 
	"DIVISA_ABREVIATURA2" VARCHAR2(20 BYTE), 
	"DIVISA_ABREVIATURA" VARCHAR2(20 BYTE), 
	"CUENTA_CUENTA_ID" NUMBER, 
	"CUENTA_CUENTA_ID1" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
-- No se ha podido presentar el DDL TABLE para el objeto FINTECH.VM_COTIZA mientras que DBMS_METADATA intenta utilizar el generador interno.
CREATE TABLE VM_COTIZA 
(
  ABREVIATURA VARCHAR2(20 BYTE) NOT NULL 
, CAMBIO_EURO NUMBER NOT NULL 
, CONSTRAINT SYS_C_SNAP$_1DIVISA_PK PRIMARY KEY 
  (
    ABREVIATURA 
  )
  USING INDEX 
  (
      CREATE UNIQUE INDEX SYS_C_SNAP$_1DIVISA_PK ON VM_COTIZA (ABREVIATURA ASC) 
      LOGGING 
      TABLESPACE TS_FINTECH 
      PCTFREE 10 
      INITRANS 2 
      STORAGE 
      ( 
        INITIAL 65536 
        NEXT 1048576 
        MINEXTENTS 1 
        MAXEXTENTS UNLIMITED 
        BUFFER_POOL DEFAULT 
      ) 
      NOPARALLEL 
  )
  ENABLE 
) 
LOGGING 
TABLESPACE TS_FINTECH 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NOPARALLEL
--------------------------------------------------------
--  DDL for Sequence CUENTA_CUENTA_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "FINTECH"."CUENTA_CUENTA_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence SQ_CLIENTE
--------------------------------------------------------

   CREATE SEQUENCE  "FINTECH"."SQ_CLIENTE"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 81 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence SQ_CUENTA
--------------------------------------------------------

   CREATE SEQUENCE  "FINTECH"."SQ_CUENTA"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 101 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence SQ_PERSONA
--------------------------------------------------------

   CREATE SEQUENCE  "FINTECH"."SQ_PERSONA"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 81 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence SQ_TRANSACCION
--------------------------------------------------------

   CREATE SEQUENCE  "FINTECH"."SQ_TRANSACCION"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 121 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
-- No se ha podido presentar el DDL MATERIALIZED VIEW para el objeto FINTECH.VM_COTIZA mientras que DBMS_METADATA intenta utilizar el generador interno.
COMMENT ON MATERIALIZED VIEW VM_COTIZA IS 'snapshot table for snapshot FINTECH.VM_COTIZA'CREATE MATERIALIZED VIEW VM_COTIZA 
LOGGING 
TABLESPACE TS_FINTECH 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NOCACHE 
NOPARALLEL 
USING INDEX 
TABLESPACE TS_FINTECH 
PCTFREE 10 
INITRANS 2 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
REFRESH 
NEXT TRUNC(SYSDATE) + 1   
FORCE 
WITH PRIMARY KEY 
USING DEFAULT LOCAL ROLLBACK SEGMENT 
DISABLE QUERY REWRITE AS 
(SELECT ABREVIATURA, CAMBIO_EURO FROM DIVISA)
REM INSERTING into FINTECH.VM_COTIZA
SET DEFINE OFF;
Insert into FINTECH.VM_COTIZA (ABREVIATURA,CAMBIO_EURO) values ('22','22');
Insert into FINTECH.VM_COTIZA (ABREVIATURA,CAMBIO_EURO) values ('EUR','1');
REM INSERTING into FINTECH.AUTORIZACION
SET DEFINE OFF;
Insert into FINTECH.AUTORIZACION (TIPO,PERSONA_AUTORIZADA_ID,EMPRESA_ID) values ('O','-1','-2');
REM INSERTING into FINTECH.CLIENTE
SET DEFINE OFF;
Insert into FINTECH.CLIENTE (ID,IDENTIFICACION,TIPO_CLIENTE,ESTADO,FECHA_ALTA,FECHA_BAJA,DIRECCION,CIUDAD,CODIGO_POSTAL,PAIS) values ('-1','INDIVIDUAL_DEFAULT','INDIVIDUAL','ACTIVO',to_date('06/06/22','DD/MM/RR'),null,'DEFAULT_ADDRESS','DEFAULT_CITY','DEFAULT_CP','DEFAULT_COUNTRY');
Insert into FINTECH.CLIENTE (ID,IDENTIFICACION,TIPO_CLIENTE,ESTADO,FECHA_ALTA,FECHA_BAJA,DIRECCION,CIUDAD,CODIGO_POSTAL,PAIS) values ('-2','EMPRESA_DEFAULT','EMPRESA','ACTIVO',to_date('06/06/22','DD/MM/RR'),null,'DEFAULT_ADDRESS','DEFAULT_CITY','DEFAULT_CP','DEFAULT_COUNTRY');
REM INSERTING into FINTECH.COTIZACION_EXT
SET DEFINE OFF;
REM INSERTING into FINTECH.CUENTA
SET DEFINE OFF;
Insert into FINTECH.CUENTA (CUENTA_ID,IBAN,SWIFT) values ('-1','SEGREGADA_DEFAULT',null);
Insert into FINTECH.CUENTA (CUENTA_ID,IBAN,SWIFT) values ('-2','REFERENCIA_DEFAULT',null);
Insert into FINTECH.CUENTA (CUENTA_ID,IBAN,SWIFT) values ('-3','POOLED_DEFAULT',null);
REM INSERTING into FINTECH.CUENTA_FINTECH
SET DEFINE OFF;
Insert into FINTECH.CUENTA_FINTECH (CUENTA_CUENTA_ID,CLIENTE_ID,ESTADO,FECHA_APERTURA,FECHA_CIERRE,CLASIFICACION) values ('-1','-1','ACTIVO',to_date('06/06/22','DD/MM/RR'),null,null);
Insert into FINTECH.CUENTA_FINTECH (CUENTA_CUENTA_ID,CLIENTE_ID,ESTADO,FECHA_APERTURA,FECHA_CIERRE,CLASIFICACION) values ('-3','-2','ACTIVO',to_date('06/06/22','DD/MM/RR'),null,null);
REM INSERTING into FINTECH.CUENTA_REFERENCIA
SET DEFINE OFF;
Insert into FINTECH.CUENTA_REFERENCIA (CUENTA_CUENTA_ID,NOMBRE_BANCO,SUCURSAL,PAIS,SALDO,FECHA_APERTURA,ESTADO,DIVISA_ABREVIATURA) values ('-2','DEFAULT_BANK',null,null,'42069',null,'ACTIVO','EUR');
REM INSERTING into FINTECH.DEPOSITAR_EN
SET DEFINE OFF;
Insert into FINTECH.DEPOSITAR_EN (SALDO,CUENTA_REF_ID,POOL_ID) values ('420','-2','-3');
REM INSERTING into FINTECH.DIVISA
SET DEFINE OFF;
Insert into FINTECH.DIVISA (ABREVIATURA,NOMBRE,SIMBOLO,CAMBIO_EURO) values ('EUR','EURO',null,'1');
REM INSERTING into FINTECH.EMPRESA
SET DEFINE OFF;
Insert into FINTECH.EMPRESA (CLIENTE_ID,RAZON_SOCIAL) values ('-2','SA');
REM INSERTING into FINTECH.INDIVIDUAL
SET DEFINE OFF;
Insert into FINTECH.INDIVIDUAL (CLIENTE_ID,NOMBRE,APELLIDO,FECHA_NACIMIENTO) values ('-1','DEFAULT_NAME','DEFAULT_SURNAME',null);
REM INSERTING into FINTECH.MOVIMIENTOS
SET DEFINE OFF;
Insert into FINTECH.MOVIMIENTOS (NUMERO,NUMERO_TARJETA,FECHA,CANTIDAD,ESTADO,MODO,TIPO_EMISOR,DIVISA) values ('420','42069',to_date('06/06/22','DD/MM/RR'),'69','PENDIENTE','DIABLO','BANCO','EUR');
Insert into FINTECH.MOVIMIENTOS (NUMERO,NUMERO_TARJETA,FECHA,CANTIDAD,ESTADO,MODO,TIPO_EMISOR,DIVISA) values ('42069','42069',to_date('06/06/22','DD/MM/RR'),'69','PENDIENTE','DIABLO','BANCO','EUR');
REM INSERTING into FINTECH.PERSONA_AUTORIZADA
SET DEFINE OFF;
Insert into FINTECH.PERSONA_AUTORIZADA (ID,IDENTIFICACION,NOMBRE,APELLIDOS,DIRECCION,FECHA_NACIMIENTO,FECHA_INICIO,ESTADO,FECHA_FIN) values ('-1','DEFAULT_PA','DEFAULT_NAME','DEFAULT_SURNAME','DEFAULT_ADDRESS',null,to_date('06/06/22','DD/MM/RR'),'ACTIVO',null);
REM INSERTING into FINTECH.POOLED_ACCOUNT
SET DEFINE OFF;
Insert into FINTECH.POOLED_ACCOUNT (CUENTA_FINTECH_ID) values ('-3');
REM INSERTING into FINTECH.SEGREGADA
SET DEFINE OFF;
Insert into FINTECH.SEGREGADA (CUENTA_FINTECH_ID,COMISION,CUENTA_REF_ID) values ('-1','0','-2');
REM INSERTING into FINTECH.TARJETAS
SET DEFINE OFF;
Insert into FINTECH.TARJETAS (NUMERO,NOMBRE_TITULAR,CVV,MARCA,FECHA_CAD,CLIENTE_ID,CUENTA_FINTECH_ID) values ('42069','TITULAR','123','VISA',to_date('06/06/24','DD/MM/RR'),'-1','-1');
REM INSERTING into FINTECH.TRANSACCION
SET DEFINE OFF;
Insert into FINTECH.TRANSACCION (ID,FECHA_INSTRUCCION,CANTIDAD,FECHA_EJECUCION,TIPO,COMISION,INTERNACIONAL,DIVISA_ABREVIATURA2,DIVISA_ABREVIATURA,CUENTA_CUENTA_ID,CUENTA_CUENTA_ID1) values ('102',to_date('06/06/22','DD/MM/RR'),'69',to_date('06/06/22','DD/MM/RR'),'TRANSFERENCIA',null,null,'EUR','EUR','-1','-3');
REM INSERTING into FINTECH.V_COTIZACIONES
SET DEFINE OFF;
REM INSERTING into FINTECH.V_PAGOS_PENDIENTES
SET DEFINE OFF;
REM INSERTING into FINTECH.V_SALDOS
SET DEFINE OFF;
Insert into FINTECH.V_SALDOS (IDENTIFICACION,IBAN,SALDO,ABREVIATURA,CAMBIO_EURO) values ('EMPRESA_DEFAULT','POOLED_DEFAULT','420','EUR','1');
Insert into FINTECH.V_SALDOS (IDENTIFICACION,IBAN,SALDO,ABREVIATURA,CAMBIO_EURO) values ('INDIVIDUAL_DEFAULT','SEGREGADA_DEFAULT','42069','EUR','1');
REM INSERTING into FINTECH.V_TARJETA_MENSUAL
SET DEFINE OFF;
Insert into FINTECH.V_TARJETA_MENSUAL (IDENTIFICACION,NUMERO_TARJETA,GASTO,ABREVIATURA) values ('INDIVIDUAL_DEFAULT','42069','138','EUR');
--------------------------------------------------------
--  DDL for Index AUTORIZACION_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."AUTORIZACION_PK" ON "FINTECH"."AUTORIZACION" ("PERSONA_AUTORIZADA_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index CLIENTE_IDENTIFICACION_UN
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."CLIENTE_IDENTIFICACION_UN" ON "FINTECH"."CLIENTE" ("IDENTIFICACION") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index CLIENTE_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."CLIENTE_PK" ON "FINTECH"."CLIENTE" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index CUENTA_FINTECH_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."CUENTA_FINTECH_PK" ON "FINTECH"."CUENTA_FINTECH" ("CUENTA_CUENTA_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index CUENTA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."CUENTA_PK" ON "FINTECH"."CUENTA" ("CUENTA_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index CUENTA_REFERENCIA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."CUENTA_REFERENCIA_PK" ON "FINTECH"."CUENTA_REFERENCIA" ("CUENTA_CUENTA_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index DIVISA_NOMBRE_MAYUS
--------------------------------------------------------

  CREATE INDEX "FINTECH"."DIVISA_NOMBRE_MAYUS" ON "FINTECH"."DIVISA" (UPPER("NOMBRE")) 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_INDICES" ;
--------------------------------------------------------
--  DDL for Index DIVISA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."DIVISA_PK" ON "FINTECH"."DIVISA" ("ABREVIATURA") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index EMPRESA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."EMPRESA_PK" ON "FINTECH"."EMPRESA" ("CLIENTE_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index INDIVIDUAL_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."INDIVIDUAL_PK" ON "FINTECH"."INDIVIDUAL" ("CLIENTE_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index MOVIMIENTOS_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."MOVIMIENTOS_PK" ON "FINTECH"."MOVIMIENTOS" ("NUMERO") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index PERSONA_AUTORIZADA_ID_UN
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."PERSONA_AUTORIZADA_ID_UN" ON "FINTECH"."PERSONA_AUTORIZADA" ("IDENTIFICACION") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index PERSONA_AUTORIZADA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."PERSONA_AUTORIZADA_PK" ON "FINTECH"."PERSONA_AUTORIZADA" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index POOLED_ACCOUNT_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."POOLED_ACCOUNT_PK" ON "FINTECH"."POOLED_ACCOUNT" ("CUENTA_FINTECH_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index REFERENCIA_DIVISA
--------------------------------------------------------

  CREATE BITMAP INDEX "FINTECH"."REFERENCIA_DIVISA" ON "FINTECH"."CUENTA_REFERENCIA" ("DIVISA_ABREVIATURA") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_INDICES" ;
--------------------------------------------------------
--  DDL for Index SEGREGADA__IDX
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."SEGREGADA__IDX" ON "FINTECH"."SEGREGADA" ("CUENTA_REF_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_INDICES" ;
--------------------------------------------------------
--  DDL for Index SEGREGADA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."SEGREGADA_PK" ON "FINTECH"."SEGREGADA" ("CUENTA_FINTECH_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index SYS_C_SNAP$_1DIVISA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."SYS_C_SNAP$_1DIVISA_PK" ON "FINTECH"."VM_COTIZA" ("ABREVIATURA") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index TARJETAS_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."TARJETAS_PK" ON "FINTECH"."TARJETAS" ("NUMERO") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Index TRANSACCION_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FINTECH"."TRANSACCION_PK" ON "FINTECH"."TRANSACCION" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH" ;
--------------------------------------------------------
--  DDL for Trigger CUENTA_CUENTA_ID_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "FINTECH"."CUENTA_CUENTA_ID_TRG" BEFORE
    INSERT ON cuenta
    FOR EACH ROW
     WHEN ( new.cuenta_id IS NULL ) BEGIN
    :new.cuenta_id := cuenta_cuenta_id_seq.nextval;
END;

/
ALTER TRIGGER "FINTECH"."CUENTA_CUENTA_ID_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger TR_TRANSACCION
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "FINTECH"."TR_TRANSACCION" 
BEFORE INSERT ON TRANSACCION FOR EACH ROW
BEGIN
    :new.ID := SQ_TRANSACCION.NEXTVAL;
END TR_TRANSACCION;


/
ALTER TRIGGER "FINTECH"."TR_TRANSACCION" ENABLE;
--------------------------------------------------------
--  DDL for Procedure P_CAMBIOEURO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "FINTECH"."P_CAMBIOEURO" 
IS
BEGIN
    UPDATE DIVISA
        SET 
            DIVISA.CAMBIO_EURO = V_COTIZACIONES.CAMBIOEURO
        WHERE
            DIVISA.ABREVIATURA = V_COTIZACIONES.ABREVIATURA;

    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
END P_CAMBIOEURO;

DBMS_SCHEDULER.CREATE_JOB(
    job_name            => 'J_CAMBIO_EURO',
    job_type            => 'PLSQL_BLOCK',
    job_action          => 'P_CAMBIOEURO;',
    start_date          => TIMESTAMP '2022-06-06 00:05:00',
    repeat_interval     => 'FREQ=DAILY; INTERVAL=1',
    end_date            => null,
    enabled             => TRUE,
    comments            => 'Actualiza el atributo cambio euro de la tabla divisa tomando el valor de la vista v_cotizaciones cada dÃ­a a las 00:05'
)

/
--------------------------------------------------------
--  DDL for Procedure P_COBRO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "FINTECH"."P_COBRO" 
IS
BEGIN
    UPDATE CUENTA_REFERENCIA
        SET 
            SALDO = f_saldo_referencia(cuenta_referencia.cuenta_cuenta_id)
        WHERE
            cuenta_cuenta_id
            IN (SELECT c.cuenta_cuenta_id FROM CUENTA_REFERENCIA c  --esta parte es por las cuentas pooled
                    JOIN DEPOSITAR_EN depo ON c.cuenta_cuenta_id = depo.cuenta_ref_id
                    JOIN POOLED_ACCOUNT pc ON pc.cuenta_fintech_id = depo.pool_id
                    JOIN CUENTA_FINTECH cf ON pc.cuenta_fintech_id = cf.cuenta_cuenta_id
                    JOIN CUENTA cuenta     ON cuenta.cuenta_id = cf.cuenta_cuenta_id
                    JOIN TARJETAS tar      ON tar.cuenta_fintech_id = cf.cuenta_cuenta_id
                    JOIN MOVIMIENTOS movi   ON movi.numero_tarjeta = tar.numero
                        WHERE movi.estado = 'PENDIENTE' AND movi.modo = 'DEBITO'
                    UNION
                SELECT c.cuenta_cuenta_id FROM CUENTA_REFERENCIA c  --esta parte es por las cuentas segregadas
                    JOIN SEGREGADA seg     ON seg.cuenta_ref_id = c.cuenta_cuenta_id
                    JOIN CUENTA_FINTECH cf ON cf.cuenta_cuenta_id = seg.cuenta_fintech_id
                    JOIN CUENTA cuenta     ON cuenta.cuenta_id = cf.cuenta_cuenta_id
                    JOIN TARJETAS tar      ON tar.cuenta_fintech_id = cf.cuenta_cuenta_id
                    JOIN MOVIMIENTOS movi   ON movi.numero_tarjeta = tar.numero
                        WHERE movi.estado = 'PENDIENTE' AND movi.modo = 'DEBITO');

    UPDATE MOVIMIENTOS
        SET
            ESTADO = 'COBRADO'
        WHERE
            ESTADO = 'PENDIENTE' AND MODO = 'DEBITO';

    -- COMMIT; 
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
END P_COBRO;

/
--------------------------------------------------------
--  DDL for Package PK_GESTION_CLIENTES
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE "FINTECH"."PK_GESTION_CLIENTES" AS 

    PROCEDURE ALTA_CLIENTE(
    P_ID_CLIENTE        IN CLIENTE.ID%TYPE, 
    P_IDENTIFICACION    IN CLIENTE.IDENTIFICACION%TYPE,
    P_TIPO_CLIENTE      IN CLIENTE.TIPO_CLIENTE%TYPE,
    P_ESTADO            IN CLIENTE.ESTADO%TYPE,
    P_FECHA_ALTA        IN CLIENTE.FECHA_ALTA%TYPE,
    P_FECHA_BAJA        IN CLIENTE.FECHA_BAJA%TYPE,     
    P_DIRECCION         IN CLIENTE.DIRECCION%TYPE,
    P_CIUDAD            IN CLIENTE.CIUDAD%TYPE,
    P_CODIGO_POSTAL     IN CLIENTE.CODIGO_POSTAL%TYPE,
    P_PAIS              IN CLIENTE.PAIS%TYPE,
    P_RAZON_SOCIAL      IN EMPRESA.RAZON_SOCIAL%TYPE,
    P_NOMBRE            IN INDIVIDUAL.NOMBRE%TYPE, 
    P_APELLIDO          IN INDIVIDUAL.APELLIDO%TYPE,
    P_FECHA_NACIMIENTO  IN INDIVIDUAL.FECHA_NACIMIENTO%TYPE);
    
    PROCEDURE MOD_CLIENTE(
    P_ID_CLIENTE        IN CLIENTE.ID%TYPE, 
    P_IDENTIFICACION    IN CLIENTE.IDENTIFICACION%TYPE,
    P_TIPO_CLIENTE      IN CLIENTE.TIPO_CLIENTE%TYPE,
    P_ESTADO            IN CLIENTE.ESTADO%TYPE,
    P_FECHA_ALTA        IN CLIENTE.FECHA_ALTA%TYPE,
    P_FECHA_BAJA        IN CLIENTE.FECHA_BAJA%TYPE,     
    P_DIRECCION         IN CLIENTE.DIRECCION%TYPE,
    P_CIUDAD            IN CLIENTE.CIUDAD%TYPE,
    P_CODIGO_POSTAL     IN CLIENTE.CODIGO_POSTAL%TYPE,
    P_PAIS              IN CLIENTE.PAIS%TYPE,
    P_RAZON_SOCIAL      IN EMPRESA.RAZON_SOCIAL%TYPE,
    P_NOMBRE            IN INDIVIDUAL.NOMBRE%TYPE, 
    P_APELLIDOS         IN INDIVIDUAL.APELLIDO%TYPE,
    P_FECHA_NACIMIENTO  IN INDIVIDUAL.FECHA_NACIMIENTO%TYPE);
    
    PROCEDURE BAJA_CLIENTE(P_IDENTIFICACION IN CLIENTE.IDENTIFICACION%TYPE);
    
    PROCEDURE ALTA_AUTORIZADO(
    P_ID_AUTORIZADO     IN PERSONA_AUTORIZADA.ID%TYPE,
    P_IDENTIFICACION    IN PERSONA_AUTORIZADA.IDENTIFICACION%TYPE,
    P_NOMBRE            IN PERSONA_AUTORIZADA.NOMBRE%TYPE,
    P_APELLIDOS         IN PERSONA_AUTORIZADA.APELLIDOS%TYPE, 
    P_DIRECCION         IN PERSONA_AUTORIZADA.DIRECCION%TYPE,
    P_FECHA_NACIMIENTO  IN PERSONA_AUTORIZADA.FECHA_NACIMIENTO%TYPE,
    P_FECHA_INICIO      IN PERSONA_AUTORIZADA.FECHA_INICIO%TYPE,
    P_ESTADO            IN PERSONA_AUTORIZADA.ESTADO%TYPE,
    P_FECHA_FIN         IN PERSONA_AUTORIZADA.FECHA_FIN%TYPE,
    P_TIPO              IN AUTORIZACION.TIPO%TYPE,
    P_ID_EMPRESA        IN AUTORIZACION.EMPRESA_ID%TYPE);
    
    PROCEDURE BAJA_AUTORIZADO(
    P_ID_AUTORIZADO IN AUTORIZACION.PERSONA_AUTORIZADA_ID%TYPE,
    P_EMPRESA_ID    IN  AUTORIZACION.EMPRESA_ID%TYPE);
    
    PROCEDURE MOD_AUTORIZADO(
    P_ID_AUTORIZADO     IN PERSONA_AUTORIZADA.ID%TYPE,
    P_IDENTIFICACION    IN PERSONA_AUTORIZADA.IDENTIFICACION%TYPE,
    P_NOMBRE            IN PERSONA_AUTORIZADA.NOMBRE%TYPE,
    P_APELLIDOS         IN PERSONA_AUTORIZADA.APELLIDOS%TYPE, 
    P_DIRECCION         IN PERSONA_AUTORIZADA.DIRECCION%TYPE,
    P_FECHA_NACIMIENTO  IN PERSONA_AUTORIZADA.FECHA_NACIMIENTO%TYPE,
    P_FECHA_INICIO      IN PERSONA_AUTORIZADA.FECHA_INICIO%TYPE,
    P_ESTADO            IN PERSONA_AUTORIZADA.ESTADO%TYPE,
    P_FECHA_FIN         IN PERSONA_AUTORIZADA.FECHA_FIN%TYPE,
    P_TIPO              IN AUTORIZACION.TIPO%TYPE,
    P_ID_EMPRESA        IN AUTORIZACION.EMPRESA_ID%TYPE);
    
    -- Excepciones
    PERSONA_AUTORIZADA_NO_EXISTENTE_EXCEPTION EXCEPTION;
    PERSONA_YA_BORRADA_EXCEPTION EXCEPTION; 
    EMPRESA_NO_EXISTENTE_EXCEPTION EXCEPTION;
    SIN_AUTORIZACIONES_EXCEPTION EXCEPTION;
    ESTADO_INACTIVO_EXCEPTION EXCEPTION;
    CUENTAS_ACTIVAS_EXCEPTION EXCEPTION;
    CLIENTE_NO_EXISTENTE_EXCEPTION EXCEPTION;
    DATOS_INCORRECTOS_EXCEPTION EXCEPTION;
    AUTORIZADO_NO_EXISTENTE_EXCEPTION EXCEPTION;
    CLIENTE_EXISTENTE_EXCEPTION EXCEPTION;
    CLIENTE_NO_VALIDO_EXCEPTION EXCEPTION;

END PK_GESTION_CLIENTES;

/
--------------------------------------------------------
--  DDL for Package PK_GESTION_CUENTAS
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE "FINTECH"."PK_GESTION_CUENTAS" AS 
    
    PROCEDURE ABRIR_CUENTA(
    P_IBAN              IN CUENTA.IBAN%TYPE,
    P_SWIFT             IN CUENTA.SWIFT%TYPE,     
    P_CLIENTE_ID        IN CUENTA_FINTECH.CLIENTE_ID%TYPE,
    P_ESTADO            IN CUENTA_FINTECH.ESTADO%TYPE,
    P_FECHA_APERTURA    IN CUENTA_FINTECH.FECHA_APERTURA%TYPE,
    P_FECHA_CIERRE      IN CUENTA_FINTECH.FECHA_CIERRE%TYPE,
    P_CLASIFICACION     IN CUENTA_FINTECH.CLASIFICACION%TYPE,
    P_COMISION          IN SEGREGADA.COMISION%TYPE,
    P_CUENTA_REF_ID     IN SEGREGADA.CUENTA_REF_ID%TYPE);
    
    PROCEDURE CERRAR_CUENTA(
    P_IBAN IN CUENTA.IBAN%TYPE);
    
    -- EXCEPTIONS
    CUENTA_EXISTENTE_EXCEPTION EXCEPTION;
    CLIENTE_DE_BAJA_EXCEPTION EXCEPTION;
    CUENTA_NO_EXISTE_EXCEPTION EXCEPTION;
    SALDO_NO_VACIO_EXCEPTION EXCEPTION;

END PK_GESTION_CUENTAS;

/
--------------------------------------------------------
--  DDL for Package PK_OPERATIVA
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE "FINTECH"."PK_OPERATIVA" AS 
    
    PROCEDURE INSERTAR_TRANSACCIONES(
--  P_ID                    ASIGNADA SQ_TRANSACCION EN RUNTIME
    P_FECHA_INSTRUCCION     IN TRANSACCION.FECHA_INSTRUCCION%TYPE,
    P_CANTIDAD              IN TRANSACCION.CANTIDAD%TYPE,
--  P_FECHA_EJECUCION       ASIGNADA EN RUNTIME
    P_TIPO                  IN TRANSACCION.TIPO%TYPE,
    P_COMISION              IN TRANSACCION.COMISION%TYPE,
    P_INTERNACIONAL         IN TRANSACCION.INTERNACIONAL%TYPE,
    P_DIVISA_ABREVIATURA    IN DIVISA.ABREVIATURA%TYPE,
    P_DIVISA_ABREVIATURA2   IN DIVISA.ABREVIATURA%TYPE,
    IBAN_1                  IN CUENTA.IBAN%TYPE,
    IBAN_2                  IN CUENTA.IBAN%TYPE
    );
    
    PROCEDURE CAMBIO_DIVISAS(
    P_IBAN              IN CUENTA.IBAN%TYPE,
    P_CANTIDAD          IN TRANSACCION.CANTIDAD%TYPE,
    P_DIVISA_ORIGEN     IN DIVISA.ABREVIATURA%TYPE,
    P_DIVISA_OBJETIVO   IN DIVISA.ABREVIATURA%TYPE
    );
    -- EXCEPTIONS
    CANTIDAD_INVALIDA_EXCEPTION EXCEPTION;
    COMISION_INVALIDA_EXCEPTION EXCEPTION;
    NULL_INTERNACIONAL_EXCEPTION EXCEPTION;
    NO_CUENTA_FINTECH_EXCEPTION EXCEPTION;
    FECHA_INVALIDA_EXCEPTION EXCEPTION;
    TIPO_INVALIDO_EXCEPTION EXCEPTION;
    CUENTAS_NO_EXISTEN_EXCEPTION EXCEPTION;
    DIVISA_NOT_FOUND_EXCEPTION EXCEPTION;
    SEGREGADA_DIVISA_NOT_MATCH EXCEPTION;
    SALDO_INSUFICIENTE_EXCEPTION EXCEPTION;
    CUENTA_NOT_FOUND_EXCEPTION EXCEPTION;

END PK_OPERATIVA;

/
--------------------------------------------------------
--  DDL for Package Body PK_GESTION_CLIENTES
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "FINTECH"."PK_GESTION_CLIENTES" AS

    PROCEDURE ALTA_CLIENTE(
    P_ID_CLIENTE        IN CLIENTE.ID%TYPE, 
    P_IDENTIFICACION    IN CLIENTE.IDENTIFICACION%TYPE,
    P_TIPO_CLIENTE      IN CLIENTE.TIPO_CLIENTE%TYPE,
    P_ESTADO            IN CLIENTE.ESTADO%TYPE,
    P_FECHA_ALTA        IN CLIENTE.FECHA_ALTA%TYPE,
    P_FECHA_BAJA        IN CLIENTE.FECHA_BAJA%TYPE,     
    P_DIRECCION         IN CLIENTE.DIRECCION%TYPE,
    P_CIUDAD            IN CLIENTE.CIUDAD%TYPE,
    P_CODIGO_POSTAL     IN CLIENTE.CODIGO_POSTAL%TYPE,
    P_PAIS              IN CLIENTE.PAIS%TYPE,
    P_RAZON_SOCIAL      IN EMPRESA.RAZON_SOCIAL%TYPE,
    P_NOMBRE            IN INDIVIDUAL.NOMBRE%TYPE, 
    P_APELLIDO          IN INDIVIDUAL.APELLIDO%TYPE,
    P_FECHA_NACIMIENTO  IN INDIVIDUAL.FECHA_NACIMIENTO%TYPE)
    IS
    ESTADO_CLIENTE       CLIENTE.ESTADO%TYPE;
    CLIENTE_ID           CLIENTE.ID%TYPE;
    BEGIN
        --Buscamos si hay un cliente con ese id 
        SELECT ID INTO CLIENTE_ID FROM CLIENTE WHERE ID LIKE P_ID_CLIENTE;
        -- CHECK DE EXISTENCIA DE CLIENTE (HABIA UN ERROR)
        IF CLIENTE_ID IS NOT NULL THEN 
            RAISE CLIENTE_EXISTENTE_EXCEPTION;
        END IF;
        
        --Se aprovecha la variable para asignar el ID según la secuencia SQ_CLIENTE
        CLIENTE_ID := SQ_CLIENTE.NEXTVAL;
        
        --Insertamos el cliente
        INSERT INTO CLIENTE (
            id,
            identificacion,
            tipo_cliente,
            estado,
            fecha_alta,
            fecha_baja,
            direccion,
            ciudad,
            codigo_postal,
            pais
        ) VALUES (
            CLIENTE_ID,
            P_IDENTIFICACION,
            P_TIPO_CLIENTE,
            P_ESTADO,
            P_FECHA_ALTA,
            P_FECHA_BAJA,     
            P_DIRECCION,
            P_CIUDAD,
            P_CODIGO_POSTAL,
            P_PAIS
        );
        
        IF P_TIPO_CLIENTE = 'EMPRESA' THEN 
            --Insertar empresa
            INSERT INTO EMPRESA (
                cliente_id,
                razon_social
            ) VALUES (
                CLIENTE_ID,
                P_RAZON_SOCIAL
            );
        ELSIF P_TIPO_CLIENTE = 'INDIVIDUAL' THEN
            --Insertar individual
            INSERT INTO individual (
                cliente_id,
                nombre,
                apellido,
                fecha_nacimiento
            ) VALUES (
                CLIENTE_ID,
                P_NOMBRE,
                P_APELLIDO,
                P_FECHA_NACIMIENTO
            );
        ELSE
            RAISE CLIENTE_NO_VALIDO_EXCEPTION;
        END IF;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
    END ALTA_CLIENTE;
    
    PROCEDURE MOD_CLIENTE(P_ID_CLIENTE IN CLIENTE.ID%TYPE,
    P_IDENTIFICACION IN CLIENTE.IDENTIFICACION%TYPE,
    P_TIPO_CLIENTE   IN CLIENTE.TIPO_CLIENTE%TYPE,
    P_ESTADO         IN CLIENTE.ESTADO%TYPE,
    P_FECHA_ALTA     IN CLIENTE.FECHA_ALTA%TYPE,
    P_FECHA_BAJA              IN CLIENTE.FECHA_BAJA%TYPE,     
    P_DIRECCION      IN CLIENTE.DIRECCION%TYPE,
    P_CIUDAD         IN CLIENTE.CIUDAD%TYPE,
    P_CODIGO_POSTAL  IN CLIENTE.CODIGO_POSTAL%TYPE,
    P_PAIS           IN CLIENTE.PAIS%TYPE,
    P_RAZON_SOCIAL IN EMPRESA.RAZON_SOCIAL%TYPE,
    P_NOMBRE            IN INDIVIDUAL.NOMBRE%TYPE,
    P_APELLIDOS         IN INDIVIDUAL.APELLIDO%TYPE,
    P_FECHA_NACIMIENTO        IN INDIVIDUAL.FECHA_NACIMIENTO%TYPE)
    IS
    CLIENTE_AUX         CLIENTE.ID%TYPE;
    IDENTIFICACION_AUX  CLIENTE.IDENTIFICACION%TYPE;
    AUX                 INTEGER;
    BEGIN
        SELECT ID INTO CLIENTE_AUX FROM CLIENTE WHERE ID LIKE P_ID_CLIENTE FOR UPDATE; -- SE BLOQUEA FILA
        IF CLIENTE_AUX IS NULL THEN
                RAISE CLIENTE_NO_EXISTENTE_EXCEPTION;
        ELSE
            -- La identificación solo se actualiza si no existe en la base de datos
            -- En caso de que la identificación no se haya cambiado se mantendrá la misma y no se actualizará
            -- En caso de que se quiera cambiar la identificación por una que ya tiene otro cliente se lanzará un ERROR
            -- En caso de que la identificación se quiera cambiar por una que no tenga ningún cliente se actualizará el valor en la tabla
            SELECT COUNT(CLIENTE.IDENTIFICACION) INTO AUX FROM CLIENTE WHERE IDENTIFICACION LIKE P_IDENTIFICACION;
            SELECT IDENTIFICACION INTO IDENTIFICACION_AUX FROM CLIENTE WHERE ID LIKE P_ID_CLIENTE;
            IF AUX = 0 THEN
                UPDATE CLIENTE
            SET
                IDENTIFICACION = P_IDENTIFICACION
            WHERE
                ID = P_ID_CLIENTE;
            ELSIF IDENTIFICACION_AUX <> P_IDENTIFICACION THEN 
                RAISE DATOS_INCORRECTOS_EXCEPTION;
            END IF;
                    
            UPDATE CLIENTE
            SET
                TIPO_CLIENTE = P_TIPO_CLIENTE,
                ESTADO = P_ESTADO,
                FECHA_ALTA = P_FECHA_ALTA,
                FECHA_BAJA = P_FECHA_BAJA,
                DIRECCION = P_DIRECCION,
                CIUDAD = P_CIUDAD,
                CODIGO_POSTAL = P_CODIGO_POSTAL,
                PAIS = P_PAIS
            WHERE
                ID = P_ID_CLIENTE;
    
           -- Se comprueba si es empresa o individual
            IF P_RAZON_SOCIAL IS NOT NULL THEN
                UPDATE EMPRESA
                SET
                    RAZON_SOCIAL = P_RAZON_SOCIAL
                WHERE
                    CLIENTE_ID = P_ID_CLIENTE;
            ELSE
                UPDATE INDIVIDUAL
                SET
                    NOMBRE = P_NOMBRE,
                    APELLIDO = P_APELLIDOS,
                    FECHA_NACIMIENTO = P_FECHA_NACIMIENTO
                WHERE
                    CLIENTE_ID = P_ID_CLIENTE;
            END IF;
        END IF;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
    END MOD_CLIENTE;
    /*
    SELECT ID INTO CLIENTE_AUX FROM CLIENTE WHERE ID LIKE P_ID_CLIENTE;
    IF CLIENTE_AUX IS NULL THEN
        RAISE CLIENTE_NO_EXISTENTE_EXCEPTION;
    ELSE
        IF P_IDENTIFICACION IS NOT NULL THEN
            SELECT COUNT(CLIENTE.IDENTIFICACION) INTO AUX FROM CLIENTE WHERE IDENTIFICACION LIKE P_IDENTIFICACION;
            IF AUX > 0 THEN
                RAISE DATOS_INCORRECTOS_EXCEPTION;
            ELSE
                UPDATE CLIENTE
                SET
                        IDENTIFICACION = P_IDENTIFICACION
                WHERE
                        ID = P_ID_CLIENTE;
            END IF;
        END IF;
        IF P_TIPO_CLIENTE IS NOT NULL THEN
            UPDATE CLIENTE
                SET
                        TIPO_CLIENTE = P_TIPO_CLIENTE
                WHERE
                        ID = P_ID_CLIENTE;
        END IF;
        IF P_ESTADO IS NOT NULL THEN
            UPDATE CLIENTE
                SET
                        ESTADO = P_ESTADO
                WHERE
                        ID = P_ID_CLIENTE;
        END IF;
        IF P_FECHA_ALTA IS NOT NULL THEN
            UPDATE CLIENTE
                SET
                        FECHA_ALTA = P_FECHA_ALTA
                WHERE
                        ID = P_ID_CLIENTE;
        END IF;
        IF P_FECHA_BAJA IS NOT NULL THEN
            UPDATE CLIENTE
                SET
                        FECHA_BAJA = P_FECHA_BAJA
                WHERE
                        ID = P_ID_CLIENTE;
        END IF;
        IF P_DIRECCION IS NOT NULL THEN
            UPDATE CLIENTE
                SET
                        DIRECCION = P_DIRECCION
                WHERE
                        ID = P_ID_CLIENTE;
        END IF;
        IF P_CIUDAD IS NOT NULL THEN
            UPDATE CLIENTE
                SET
                        CIUDAD = P_CIUDAD
                WHERE
                        ID = P_ID_CLIENTE;
        END IF;
        IF P_CODIGO_POSTAL IS NOT NULL THEN
            UPDATE CLIENTE
                SET
                        CODIGO_POSTAL = P_CODIGO_POSTAL
                WHERE
                        ID = P_ID_CLIENTE;
        END IF;
        IF P_PAIS IS NOT NULL THEN
            UPDATE CLIENTE
                SET
                        PAIS = P_PAIS
                WHERE
                        ID = P_ID_CLIENTE;
        END IF;
        IF P_RAZON_SOCIAL IS NOT NULL THEN
            UPDATE EMPRESA
                SET
                        RAZON_SOCIAL = P_RAZON_SOCIAL
                WHERE
                        CLIENTE_ID = P_ID_CLIENTE;
        END IF;
        IF P_NOMBRE IS NOT NULL THEN
            UPDATE INDIVIDUAL
                SET
                        NOMBRE = P_NOMBRE
                WHERE
                        CLIENTE_ID = P_ID_CLIENTE;
        END IF;
        IF P_APELLIDOS IS NOT NULL THEN
            UPDATE INDIVIDUAL
                SET
                        APELLIDO = P_APELLIDOS
                WHERE
                        CLIENTE_ID = P_ID_CLIENTE;
        END IF;
        IF P_FECHA_NACIMIENTO IS NOT NULL THEN
            UPDATE INDIVIDUAL
                SET
                        FECHA_NACIMIENTO = P_FECHA_NACIMIENTO
                WHERE
                        CLIENTE_ID = P_ID_CLIENTE;
        END IF;
    END IF;
    
    END MOD_CLIENTE;
    */
    
    PROCEDURE BAJA_CLIENTE(P_IDENTIFICACION IN CLIENTE.IDENTIFICACION%TYPE)
    IS
    ESTADO_CLIENTE      CLIENTE.ESTADO%TYPE;
    CLIENTE_ID          CLIENTE.ID%TYPE;
    CONT                INTEGER;
    BEGIN
        SELECT ESTADO, ID INTO ESTADO_CLIENTE, CLIENTE_ID FROM CLIENTE WHERE IDENTIFICACION LIKE P_IDENTIFICACION FOR UPDATE; -- SE BLOQUEA FILA
        -- CHECK DE EXISTENCIA DE CLIENTE (HABIA UN ERROR)
        IF CLIENTE_ID IS NULL THEN 
            RAISE CLIENTE_NO_EXISTENTE_EXCEPTION;
        END IF;
        
        -- check de numero de cuentas, si tiene alguna cuenta fintech que haga referencia al cliente, saltara excepcion
        SELECT CLIENTE_ID INTO CONT FROM CUENTA_FINTECH WHERE CLIENTE_ID LIKE CLIENTE_ID; -- SE BLOQUEA FILA, INTO NECESARIO NO USADO
        SELECT COUNT(CLIENTE_ID) INTO CONT FROM CUENTA_FINTECH WHERE CLIENTE_ID LIKE CLIENTE_ID;
        IF CONT > 0 THEN
            RAISE CUENTAS_ACTIVAS_EXCEPTION;
        END IF;
        
        -- check de estado del cliente, si esta ya inactivo saltara una excepcion, en otro caso se setea su estado a inactivo y la fecha de baja se actualiza
        IF ESTADO_CLIENTE NOT LIKE 'ACTIV[OAE]' THEN
            RAISE ESTADO_INACTIVO_EXCEPTION;
        ELSE
            UPDATE CLIENTE
            SET
                ESTADO = 'INACTIVO',
                FECHA_BAJA = SYSDATE
            WHERE
                IDENTIFICACION = P_IDENTIFICACION;
        END IF;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
    END BAJA_CLIENTE;
    
    
    PROCEDURE ALTA_AUTORIZADO(
    P_ID_AUTORIZADO     IN PERSONA_AUTORIZADA.ID%TYPE,
    P_IDENTIFICACION    IN PERSONA_AUTORIZADA.IDENTIFICACION%TYPE,
    P_NOMBRE            IN PERSONA_AUTORIZADA.NOMBRE%TYPE,
    P_APELLIDOS         IN PERSONA_AUTORIZADA.APELLIDOS%TYPE, 
    P_DIRECCION         IN PERSONA_AUTORIZADA.DIRECCION%TYPE,
    P_FECHA_NACIMIENTO  IN PERSONA_AUTORIZADA.FECHA_NACIMIENTO%TYPE,
    P_FECHA_INICIO      IN PERSONA_AUTORIZADA.FECHA_INICIO%TYPE,
    P_ESTADO            IN PERSONA_AUTORIZADA.ESTADO%TYPE,
    P_FECHA_FIN         IN PERSONA_AUTORIZADA.FECHA_FIN%TYPE,
    P_TIPO              IN AUTORIZACION.TIPO%TYPE,
    P_ID_EMPRESA        IN AUTORIZACION.EMPRESA_ID%TYPE)
    IS
    ID_AUX              PERSONA_AUTORIZADA.ID%TYPE;
    BEGIN
        SELECT ID INTO ID_AUX FROM PERSONA_AUTORIZADA WHERE ID LIKE P_ID_AUTORIZADO;
        IF ID_AUX IS NULL THEN
    
            --Se aprovecha la variable para asignar el ID según la secuencia SQ_CLIENTE
            ID_AUX := SQ_CLIENTE.NEXTVAL;
            INSERT INTO PERSONA_AUTORIZADA (
                ID,
                IDENTIFICACION,
                NOMBRE,
                APELLIDOS,
                DIRECCION,
                FECHA_NACIMIENTO,
                FECHA_INICIO,
                ESTADO,
                FECHA_FIN
            ) VALUES (
                ID_AUX,
                P_IDENTIFICACION,
                P_NOMBRE,
                P_APELLIDOS,
                P_DIRECCION,
                P_FECHA_NACIMIENTO,
                P_FECHA_INICIO,
                P_ESTADO,
                P_FECHA_FIN
            );
        END IF;
        IF P_TIPO <> 'CONSULTA' AND P_TIPO <> 'OPERACI[ÓO]N' THEN
            RAISE DATOS_INCORRECTOS_EXCEPTION;
        ELSE
            INSERT INTO AUTORIZACION (TIPO, PERSONA_AUTORIZADA_ID, EMPRESA_ID)
            VALUES (P_TIPO, P_ID_AUTORIZADO, P_ID_EMPRESA);
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
    END ALTA_AUTORIZADO;
    
    PROCEDURE BAJA_AUTORIZADO(
    P_ID_AUTORIZADO IN AUTORIZACION.PERSONA_AUTORIZADA_ID%TYPE,
    P_EMPRESA_ID    IN  AUTORIZACION.EMPRESA_ID%TYPE)
    IS
    PERSONA_AUTORIZADA_ID_AUX   PERSONA_AUTORIZADA.ID%TYPE;
    ESTADO_PERSONA              PERSONA_AUTORIZADA.ESTADO%TYPE;
    EMPRESA_ID_AUX              AUTORIZACION.EMPRESA_ID%TYPE;
    CONT_AUT_EMP                INTEGER;
    CONT_AUT_GEN                INTEGER;
    BEGIN
        
        -- CHECK DE QUE LA PERSONA AUTORIZADA EXISTE
        SELECT ID INTO PERSONA_AUTORIZADA_ID_AUX FROM PERSONA_AUTORIZADA WHERE ID LIKE P_ID_AUTORIZADO FOR UPDATE; -- SE BLOQUEA FILA
        SELECT ESTADO INTO ESTADO_PERSONA FROM PERSONA_AUTORIZADA WHERE ID LIKE PERSONA_AUTORIZADA_ID_AUX;
        IF PERSONA_AUTORIZADA_ID_AUX IS NULL THEN
            RAISE PERSONA_AUTORIZADA_NO_EXISTENTE_EXCEPTION;
        END IF;
        --CHECK DE QUE LA EMPRESA EXISTE
        SELECT ID INTO EMPRESA_ID_AUX FROM CLIENTE WHERE ID LIKE P_EMPRESA_ID FOR UPDATE; -- SE BLOQUEA FILA (NO SE PERMITE AÑADIR EMPRESAS CUANDO SE VA A DAR DE BAJA)
        IF EMPRESA_ID_AUX IS NULL THEN 
            RAISE EMPRESA_NO_EXISTENTE_EXCEPTION;
        END IF;
        -- CHECK DE QUE EL ESTADO NO SEA YA BORRADO
        IF ESTADO_PERSONA LIKE 'BORRADO' THEN
            RAISE PERSONA_YA_BORRADA_EXCEPTION;
        END IF;
        -- CHECK DE LAS AUTORIZACIONES QUE TIENE LA PERSONA AUTORIZADA CON LA EMPRESA + BORRARLAS SI TIENE
        SELECT PERSONA_AUTORIZADA_ID INTO CONT_AUT_EMP FROM AUTORIZACION WHERE PERSONA_AUTORIZADA_ID LIKE PERSONA_AUTORIZADA_ID_AUX FOR UPDATE; -- SE BLOQUEA FILA, NO AÑADIR AUOTIRIZACIONES DURANTE BAJA
        SELECT COUNT(PERSONA_AUTORIZADA_ID) INTO CONT_AUT_EMP FROM AUTORIZACION WHERE EMPRESA_ID LIKE EMPRESA_ID_AUX AND PERSONA_AUTORIZADA_ID LIKE PERSONA_AUTORIZADA_ID_AUX;
        IF CONT_AUT_EMP > 0 THEN 
            DELETE  FROM AUTORIZACION 
            WHERE   PERSONA_AUTORIZADA_ID LIKE PERSONA_AUTORIZADA_ID_AUX AND
                    EMPRESA_ID LIKE EMPRESA_ID_AUX;
        ELSE 
            RAISE SIN_AUTORIZACIONES_EXCEPTION;
        END IF;
        
        -- CHECK DE LAS AUTORIZACIONES QUE TIENE LA PERSONA EN GENERAL. (SI TIENE 0 SE CAMBIA EL ESTADO DE LA PERSONA AUTORIZADA)
        SELECT COUNT(PERSONA_AUTORIZADA_ID) INTO CONT_AUT_GEN FROM AUTORIZACION WHERE PERSONA_AUTORIZADA_ID LIKE PERSONA_AUTORIZADA_ID_AUX;
        IF CONT_AUT_GEN <= 0 THEN
            UPDATE PERSONA_AUTORIZADA
            SET
                ESTADO = 'BORRADO',
                FECHA_FIN = SYSDATE
            WHERE
                ID = PERSONA_AUTORIZADA_ID_AUX;
        END IF;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
    END BAJA_AUTORIZADO;
    
    PROCEDURE MOD_AUTORIZADO(
    P_ID_AUTORIZADO     IN PERSONA_AUTORIZADA.ID%TYPE,
    P_IDENTIFICACION    IN PERSONA_AUTORIZADA.IDENTIFICACION%TYPE,
    P_NOMBRE            IN PERSONA_AUTORIZADA.NOMBRE%TYPE,
    P_APELLIDOS         IN PERSONA_AUTORIZADA.APELLIDOS%TYPE, 
    P_DIRECCION         IN PERSONA_AUTORIZADA.DIRECCION%TYPE,
    P_FECHA_NACIMIENTO  IN PERSONA_AUTORIZADA.FECHA_NACIMIENTO%TYPE,
    P_FECHA_INICIO      IN PERSONA_AUTORIZADA.FECHA_INICIO%TYPE,
    P_ESTADO            IN PERSONA_AUTORIZADA.ESTADO%TYPE,
    P_FECHA_FIN         IN PERSONA_AUTORIZADA.FECHA_FIN%TYPE,
    P_TIPO              IN AUTORIZACION.TIPO%TYPE,
    P_ID_EMPRESA        IN AUTORIZACION.EMPRESA_ID%TYPE)
    IS
    AUTORIZADO_ID  PERSONA_AUTORIZADA.ID%TYPE;
    AUX            INTEGER;
    BEGIN
    
        SELECT ID INTO AUTORIZADO_ID FROM PERSONA_AUTORIZADA WHERE ID LIKE P_ID_AUTORIZADO FOR UPDATE; -- SE BLOQUEA FILA
        -- CHECK DE EXISTENCIA DE AUTORIZADO (HABIA UN ERROR)
        IF AUTORIZADO_ID IS NULL THEN 
            RAISE AUTORIZADO_NO_EXISTENTE_EXCEPTION;
        END IF;
            UPDATE PERSONA_AUTORIZADA
            SET
                IDENTIFICACION = P_IDENTIFICACION,
                NOMBRE = P_NOMBRE,
                APELLIDOS = P_APELLIDOS,
                DIRECCION = P_DIRECCION,
                FECHA_NACIMIENTO = P_FECHA_NACIMIENTO,
                FECHA_INICIO = P_FECHA_INICIO,
                ESTADO = P_ESTADO,
                FECHA_FIN = FECHA_FIN
            WHERE
                ID = P_ID_AUTORIZADO;
            
            UPDATE AUTORIZACION
            SET 
                TIPO = P_TIPO,
                -- Consideramos que la empresa no debería  
                EMPRESA_ID = P_ID_EMPRESA
            WHERE 
                PERSONA_AUTORIZADA_ID = P_ID_AUTORIZADO;
                
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
        
        --Quisimos hacerlo de esta manera pero creemos que nos puede complicar la lógica del proyecto en un futuro, por lo que hemos decidido apartarla
        /*
        IF P_IDENTIFICACION IS NOT NULL THEN
            SELECT COUNT(IDENTIFICACION) INTO AUX FROM PERSONA_AUTORIZADA WHERE IDENTIFICACION LIKE P_IDENTIFICACION;
            IF AUX > 0 THEN
                RAISE DATOS_INCORRECTOS_EXCEPTION;
            ELSE
                UPDATE PERSONA_AUTORIZADA
                SET
                        IDENTIFICACION = P_IDENTIFICACION
                WHERE
                        ID = P_ID_AUTORIZADO;
            END IF;
        END IF;
        IF P_NOMBRE IS NOT NULL THEN
            UPDATE PERSONA_AUTORIZADA
                SET
                        NOMBRE = P_NOMBRE
                WHERE
                        ID = P_ID_AUTORIZADO;
        END IF;
        IF P_APELLIDOS IS NOT NULL THEN
            UPDATE PERSONA_AUTORIZADA
                SET
                        APELLIDOS = P_APELLIDOS
                WHERE
                        ID = P_ID_AUTORIZADO;
        END IF;
        IF P_DIRECCION IS NOT NULL THEN
            UPDATE PERSONA_AUTORIZADA
                SET
                        DIRECCION = P_DIRECCION
                WHERE
                        ID = P_ID_AUTORIZADO;
        END IF;
        IF P_FECHA_NACIMIENTO IS NOT NULL THEN
            UPDATE PERSONA_AUTORIZADA
                SET
                        FECHA_NACIMIENTO = P_FECHA_NACIMIENTO
                WHERE
                        ID = P_ID_AUTORIZADO;
        END IF;
        IF P_FECHA_INICIO IS NOT NULL THEN
            UPDATE PERSONA_AUTORIZADA
                SET
                        DIRECCION = P_DIRECCION
                WHERE
                        ID = P_ID_AUTORIZADO;
        END IF;
        IF P_ESTADO IS NOT NULL THEN
            UPDATE PERSONA_AUTORIZADA
                SET
                        ESTADO = P_ESTADO
                WHERE
                        ID = P_ID_AUTORIZADO;
        END IF;
        IF P_FECHA_FIN IS NOT NULL THEN
            UPDATE PERSONA_AUTORIZADA
                SET
                        FECHA_FIN = P_FECHA_FIN
                WHERE
                        ID = P_ID_AUTORIZADO;
        END IF;
        */
    
    END MOD_AUTORIZADO;


END PK_GESTION_CLIENTES;

/
--------------------------------------------------------
--  DDL for Package Body PK_GESTION_CUENTAS
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "FINTECH"."PK_GESTION_CUENTAS" AS
    -- Commit debde de realizarse fuera del procedimeinto (principio de responsabilidad)
    PROCEDURE ABRIR_CUENTA(
    P_IBAN              IN CUENTA.IBAN%TYPE,
    P_SWIFT             IN CUENTA.SWIFT%TYPE,      
    P_CLIENTE_ID        IN CUENTA_FINTECH.CLIENTE_ID%TYPE,
    P_ESTADO            IN CUENTA_FINTECH.ESTADO%TYPE,
    P_FECHA_APERTURA    IN CUENTA_FINTECH.FECHA_APERTURA%TYPE,
    P_FECHA_CIERRE      IN CUENTA_FINTECH.FECHA_CIERRE%TYPE,
    P_CLASIFICACION     IN CUENTA_FINTECH.CLASIFICACION%TYPE,
    P_COMISION          IN SEGREGADA.COMISION%TYPE,
    P_CUENTA_REF_ID     IN SEGREGADA.CUENTA_REF_ID%TYPE)
    IS
    ESTADO_CLIENTE CUENTA_FINTECH.ESTADO%TYPE;
    P_CUENTA_ID CUENTA.CUENTA_ID%TYPE;
    BEGIN
        SELECT ESTADO INTO ESTADO_CLIENTE FROM CLIENTE WHERE ID LIKE P_CLIENTE_ID;
        SELECT CUENTA_ID INTO P_CUENTA_ID FROM CUENTA WHERE IBAN LIKE P_IBAN;
        
        IF ESTADO_CLIENTE NOT LIKE 'ACTIVO' THEN
            RAISE CLIENTE_DE_BAJA_EXCEPTION;
        END IF;
        IF P_CUENTA_ID IS NOT NULL THEN
            RAISE CUENTA_EXISTENTE_EXCEPTION;
        END IF;
        
        INSERT INTO cuenta (
            cuenta_id,
            iban,
            swift
        ) VALUES (
            SQ_CUENTA.NEXTVAL,
            P_IBAN,
            P_SWIFT
        );
        
        INSERT INTO cuenta_fintech (
            cuenta_cuenta_id,
            cliente_id,
            estado,
            fecha_apertura,
            fecha_cierre,
            clasificacion
        ) VALUES (
            SQ_CUENTA.CURRVAL,
            P_CLIENTE_ID,
            P_ESTADO,
            P_FECHA_APERTURA,
            P_FECHA_CIERRE,
            P_CLASIFICACION
        );
        
        IF P_CUENTA_REF_ID IS NULL THEN
            INSERT INTO pooled_account (
                cuenta_fintech_id
            ) VALUES (
                SQ_CUENTA.CURRVAL
            );
        ELSE
            INSERT INTO segregada (
                cuenta_fintech_id,
                comision,
                cuenta_ref_id
            ) VALUES (
                SQ_CUENTA.CURRVAL,
                P_COMISION,
                P_CUENTA_REF_ID
            );
        END IF;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
    END;
    
    
    PROCEDURE CERRAR_CUENTA(
    P_IBAN IN CUENTA.IBAN%TYPE)
    IS
    REF_SEGREGADA CUENTA.CUENTA_ID%TYPE;
    SALDO_MAYOR DEPOSITAR_EN.SALDO%TYPE;
    P_CUENTA_ID CUENTA.CUENTA_ID%TYPE;
    BEGIN
        SELECT CUENTA_ID INTO P_CUENTA_ID FROM CUENTA WHERE IBAN LIKE P_IBAN;
        SELECT CUENTA_REF_ID INTO REF_SEGREGADA FROM SEGREGADA WHERE CUENTA_FINTECH_ID = P_CUENTA_ID;
        IF REF_SEGREGADA IS NOT NULL THEN
            SELECT SALDO INTO SALDO_MAYOR FROM CUENTA_REFERENCIA WHERE CUENTA_CUENTA_ID = REF_SEGREGADA FOR UPDATE; -- SE BLOQUEA FILA
            IF SALDO_MAYOR <> 0 THEN
                RAISE SALDO_NO_VACIO_EXCEPTION;  
            END IF;
        ELSE
            SELECT SALDO INTO SALDO_MAYOR FROM DEPOSITAR_EN WHERE POOL_ID = P_CUENTA_ID FOR UPDATE; --  SE BLOQUEA FILA, INTO NECESARIO PERO NO USAD
            SELECT MAX(SALDO) INTO SALDO_MAYOR FROM DEPOSITAR_EN WHERE POOL_ID = P_CUENTA_ID;
            -- En caso de no cumplirse el predicado del WHERE la variables SALDO_MAYOR deberia ser nula
            IF SALDO_MAYOR IS NULL THEN
                RAISE CUENTA_NO_EXISTE_EXCEPTION;
            END IF;
            IF SALDO_MAYOR <> 0 THEN
                RAISE SALDO_NO_VACIO_EXCEPTION;
            END IF;
        END IF;
        
        UPDATE CUENTA_FINTECH
        SET
            ESTADO = 'INACTIVA',
            FECHA_CIERRE = SYSDATE
        WHERE
            CUENTA_CUENTA_ID = P_CUENTA_ID;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
    END;
END PK_GESTION_CUENTAS;

/
--------------------------------------------------------
--  DDL for Package Body PK_OPERATIVA
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "FINTECH"."PK_OPERATIVA" AS 
    
    PROCEDURE INSERTAR_TRANSACCIONES(
--  P_ID                    ASIGNADA SQ_TRANSACCION EN RUNTIME
    P_FECHA_INSTRUCCION     IN TRANSACCION.FECHA_INSTRUCCION%TYPE, -- IF NULL -> SYSDATE
    P_CANTIDAD              IN TRANSACCION.CANTIDAD%TYPE, -- IF <= 0 -> EXCEPTION
--  P_FECHA_EJECUCION       ASIGNADA EN RUNTIME
    P_TIPO                  IN TRANSACCION.TIPO%TYPE, -- NO CONTROLADO
    P_COMISION              IN TRANSACCION.COMISION%TYPE, -- IF < 0 -> EXCEPTION
    P_INTERNACIONAL         IN TRANSACCION.INTERNACIONAL%TYPE, -- IF NULL -> EXCEPTION
    P_DIVISA_ABREVIATURA    IN DIVISA.ABREVIATURA%TYPE, -- IF NOT FOUND -> EXCEPTION
    P_DIVISA_ABREVIATURA2   IN DIVISA.ABREVIATURA%TYPE, -- IF NOT FOUND -> EXCEPTION
    IBAN_1                  IN CUENTA.IBAN%TYPE, -- MAYBE FINTECH, REFERENCIA OR CUENTA (BARE)
    IBAN_2                  IN CUENTA.IBAN%TYPE  -- MAYBE FINTECH, REFERENCIA OR CUENTA (BARE)
    )
    IS -- VARIABLES
    DIVISA_1 DIVISA.ABREVIATURA%TYPE;
    DIVISA_2 DIVISA.ABREVIATURA%TYPE;
    CUENTA_1 CUENTA.CUENTA_ID%TYPE;
    CUENTA_2 CUENTA.CUENTA_ID%TYPE;
    FINTECH  CUENTA.CUENTA_ID%TYPE;
    P_SALDO  CUENTA_REFERENCIA.SALDO%TYPE;
    DIVISA_R CUENTA_REFERENCIA.DIVISA_ABREVIATURA%TYPE;
    CAMBIO_1 DIVISA.CAMBIO_EURO%TYPE;
    CAMBIO_2 DIVISA.CAMBIO_EURO%TYPE;
    IMPORTE  TRANSACCION.CANTIDAD%TYPE;
    REF_AUX  CUENTA_REFERENCIA.CUENTA_CUENTA_ID%TYPE;
    P_FECHA  TRANSACCION.FECHA_INSTRUCCION%TYPE;
    BEGIN
        IF P_FECHA_INSTRUCCION IS NULL THEN
            P_FECHA := SYSDATE;
        END IF;
        IF P_CANTIDAD <= 0 THEN
            RAISE CANTIDAD_INVALIDA_EXCEPTION;
        END IF;
        IF P_COMISION < 0 THEN
            RAISE COMISION_INVALIDA_EXCEPTION;
        END IF;
        IF P_INTERNACIONAL IS NULL THEN
            RAISE NULL_INTERNACIONAL_EXCEPTION;
        END IF;

        -- FIND DIVISAS DE TRANSACCIÃN
        SELECT ABREVIATURA INTO DIVISA_1 FROM DIVISA WHERE ABREVIATURA LIKE P_DIVISA_ABREVIATURA;
        SELECT ABREVIATURA INTO DIVISA_2 FROM DIVISA WHERE ABREVIATURA LIKE P_DIVISA_ABREVIATURA2;
        IF DIVISA_1 IS NULL OR DIVISA_2 IS NULL THEN
            RAISE DIVISA_NOT_FOUND_EXCEPTION;
        END IF;

        -- FIND CUENTAS
        SELECT CUENTA_ID INTO CUENTA_1 FROM CUENTA WHERE IBAN LIKE IBAN_1 FOR UPDATE; -- NO SE PERMITE INSERTAR O ELIMINAR LA CUENTA DURANTE TRANSACCIÃN
        SELECT CUENTA_ID INTO CUENTA_2 FROM CUENTA WHERE IBAN LIKE IBAN_2 FOR UPDATE; -- NO SE PERMITE INSERTAR O ELIMINAR LA CUENTA DURANTE TRANSACCIÃN

        -- SI AMBAS CUENTAS NO SE ENCUENTRAN EN LA BD, LA TRANSACCIÃN ES INVÃ?LIDA
        IF CUENTA_1 IS NULL AND CUENTA_2 IS NULL THEN
            RAISE CUENTAS_NO_EXISTEN_EXCEPTION;
        END IF;
        
        -- SE CONVIERTE A LA DIVISA DE LA CUENTA
        SELECT CAMBIO_EURO INTO CAMBIO_1 FROM DIVISA WHERE ABREVIATURA = P_DIVISA_ABREVIATURA FOR UPDATE; -- NO SE PERMITE ACTUALIZAR EL CAMBIO DURANTE TRANSSACCIÃN
        SELECT CAMBIO_EURO INTO CAMBIO_2 FROM DIVISA WHERE ABREVIATURA = P_DIVISA_ABREVIATURA2 FOR UPDATE;-- NO SE PERMITE ACTUALIZAR EL CAMBIO DURANTE TRANSSACCIÃN
        IMPORTE := (P_CANTIDAD * CAMBIO_1) / CAMBIO_2;

        -- SI ALGUNA DE ELLAS NO SE ENCUNTRA EN LA BD, SE TOMA COMO EXTERNA Y
        -- SE CREA UNA CUENTA CON ESTE IBAN COMO REFERENCIA A UNA CUENTA EXTERNA
        IF CUENTA_1 IS NULL THEN -- CUENTA_1 ESTÃ? REGISTRADA
            -- SE COMPRUEBA QUE LA OTRA CUENTA SEA FINTECH
            -- NO ES NECESARIO BLOQUEAR LAS CUENTAS FINTECH, SEGREGADAS O POOLED YA QUE CUENTA ESTÃ? BLOQUEADA
            SELECT CUENTA_CUENTA_ID INTO CUENTA_2 FROM CUENTA_FINTECH WHERE CUENTA_CUENTA_ID = CUENTA_2;
            IF CUENTA_2 IS NULL THEN
                RAISE NO_CUENTA_FINTECH_EXCEPTION;
            END IF;
            
            -- SE COMPRUEBA QUE SEA SEGREGADA O POOLED
            SELECT CUENTA_FINTECH_ID INTO FINTECH FROM POOLED_ACCOUNT WHERE CUENTA_FINTECH_ID = CUENTA_2;
            IF FINTECH IS NULL THEN

                SELECT CUENTA_FINTECH_ID INTO FINTECH FROM SEGREGADA WHERE CUENTA_FINTECH_ID = CUENTA_2;
                IF FINTECH IS NULL THEN -- NO ES NI POOLED NI SEGREGADA -> EXCEPTION
                    RAISE NO_CUENTA_FINTECH_EXCEPTION;
                ELSE -- LA CUENTA FINTECH ES SEGREGADA

                    -- SE COMPRUEBA QUE LAS DIVISAS COINCIDAN Y SE GUARDA ID DE CUENTA_REFERENCIA
                    SELECT CR.DIVISA_ABREVIATURA, CR.CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA CR
                    JOIN SEGREGADA S ON S.CUENTA_REF_ID = CR.CUENTA_CUENTA_ID
                    WHERE S.CUENTA_FINTECH_ID = FINTECH;

                    IF DIVISA_R <> P_DIVISA_ABREVIATURA2 THEN -- DIVISAS NO COINCIDEN -> EXCEPTION
                        RAISE SEGREGADA_DIVISA_NOT_MATCH;
                    END IF;

                    -- AUMENTAR SALDO
                    UPDATE CUENTA_REFERENCIA SET SALDO = SALDO + IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                END IF;
            ELSE -- LA CUENTA FINTECH ES POOLED

                -- SE BUSCA LA DIVISA DESEADA EN LA POOLED, SI NO SE ENCUENTRA SE CREA
                SELECT CR.DIVISA_ABREVIATURA, CR.CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA CR
                JOIN DEPOSITAR_EN D ON D.CUENTA_REF_ID = CR.CUENTA_CUENTA_ID
                JOIN POOLED_ACCOUNT P ON P.CUENTA_FINTECH_ID = D.POOL_ID
                WHERE P.CUENTA_FINTECH_ID = FINTECH
                AND CR.DIVISA_ABREVIATURA LIKE P_DIVISA_ABREVIATURA2
                FOR UPDATE;

                IF DIVISA_R IS NULL OR REF_AUX IS NULL THEN -- DIVISA NOT FOUND -> CREAR CUENTA_REF CON DIVISA
                    REF_AUX := SQ_CUENTA.NEXTVAL;
                    -- ID BY SEQUENCE, BANCO: DEFAULT, SALDO INICIADO CON CANTIDAD DE TRANSACCION
                    INSERT INTO CUENTA_REFERENCIA VALUES (REF_AUX, 'DEFAULT', NULL, NULL, IMPORTE, SYSDATE, 'ACTIVO', P_DIVISA_ABREVIATURA2);
                    -- SE ASIGNA A LA CUENTA POOLED LA NUEVA CUENTA REFERENCIA CON EL SALDO DE LA TRANSACCION
                    INSERT INTO DEPOSITAR_EN VALUES (IMPORTE, REF_AUX, FINTECH);
                ELSE -- CUENTA POOLED YA TIENE REF CON DIVISA DESEADA
                    -- AGREGAR TRANSACCION A SALDO
                    UPDATE CUENTA_REFERENCIA SET SALDO = SALDO + IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                    UPDATE DEPOSITAR_EN SET SALDO = SALDO + IMPORTE WHERE CUENTA_REF_ID = REF_AUX AND POOL_ID = FINTECH;
                END IF;

            END IF;

            -- CREAR CUENTA EXTERNA NO REGISTRADA
            CUENTA_1 := SQ_CUENTA.NEXTVAL;
            INSERT INTO CUENTA VALUES (CUENTA_1, IBAN_1, NULL); -- ID BY SEQUENCE SWIFT IS NULL
                
        ELSIF CUENTA_2 IS NULL THEN -- CUENTA_2 NO ESTÃ? REGISTRADA

            -- SE COMPRUEBA QUE LA OTRA CUENTA SEA FINTECH
            SELECT CUENTA_CUENTA_ID INTO CUENTA_1 FROM CUENTA_FINTECH WHERE CUENTA_CUENTA_ID = CUENTA_1;
            IF CUENTA_1 IS NULL THEN
                RAISE NO_CUENTA_FINTECH_EXCEPTION;
            END IF;
            
            -- SE COMPRUEBA QUE SEA SEGREGADA O POOLED
            SELECT CUENTA_FINTECH_ID INTO FINTECH FROM POOLED_ACCOUNT WHERE CUENTA_FINTECH_ID = CUENTA_1;
            IF FINTECH IS NULL THEN

                SELECT CUENTA_FINTECH_ID INTO FINTECH FROM SEGREGADA WHERE CUENTA_FINTECH_ID = CUENTA_1;
                IF FINTECH IS NULL THEN -- NO ES NI POOLED NI SEGREGADA -> EXCEPTION
                    RAISE NO_CUENTA_FINTECH_EXCEPTION;
                ELSE -- LA CUENTA FINTECH ES SEGREGADA

                    -- SE COMPRUEBA QUE LAS DIVISAS COINCIDAN Y SE GUARDA ID DE CUENTA_REFERENCIA
                    SELECT DIVISA_ABREVIATURA, CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA
                    JOIN SEGREGADA ON SEGREGADA.CUENTA_REF_ID = CUENTA_REFERENCIA.CUENTA_CUENTA_ID
                    WHERE SEGREGADA.CUENTA_FINTECH_ID = FINTECH
                    FOR UPDATE;

                    IF DIVISA_R <> P_DIVISA_ABREVIATURA THEN -- DIVISAS NO COINCIDEN -> EXCEPTION
                        RAISE SEGREGADA_DIVISA_NOT_MATCH;
                    END IF;

                    -- COMPROBAR SALDO SUFICIENTE
                    -- CUENTA_REFERENCIA SÃ? ES NECESARIO BLOQUEARLA YA QUE EL SALDO SE PODRÃ?A MODIFICAR DURANTE TRANSACCIÃN
                    SELECT SALDO INTO P_SALDO FROM CUENTA_REFERENCIA WHERE CUENTA_CUENTA_ID = REF_AUX FOR UPDATE;
                    IF P_SALDO < IMPORTE THEN
                        RAISE SALDO_INSUFICIENTE_EXCEPTION;
                    END IF;

                    -- REDUCIR SALDO
                    UPDATE CUENTA_REFERENCIA SET SALDO = SALDO - IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                END IF;
            ELSE -- LA CUENTA FINTECH ES POOLED

                -- SE BUSCA LA DIVISA DESEADA EN LA POOLED, SI NO SE ENCUENTRA SE CREA
                -- SE ASUME QUE SOLO EXISTE UNA CUENTA REFERENCIA POR DIVISA --
                SELECT CR.DIVISA_ABREVIATURA, CR.CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA CR
                JOIN DEPOSITAR_EN D ON D.CUENTA_REF_ID = CR.CUENTA_CUENTA_ID
                JOIN POOLED_ACCOUNT P ON P.CUENTA_FINTECH_ID = D.POOL_ID
                WHERE P.CUENTA_FINTECH_ID = FINTECH
                AND CR.DIVISA_ABREVIATURA LIKE P_DIVISA_ABREVIATURA;

                IF DIVISA_R IS NULL OR REF_AUX IS NULL THEN -- DIVISA NOT FOUND -> EXCEPTION
                    -- NO SE PUEDE CREAR UNA NUEVA CUENTA REFERENCIA YA QUE EL SALDO SERÃ?A 0
                    -- AQUÃ? LA CUENTA POOLED ES LA EMISORA DE LA TRANSACCIÃN LUEGO EL SALDO NO PUEDE SER 0
                    RAISE DIVISA_NOT_FOUND_EXCEPTION;
                ELSE -- CUENTA POOLED YA TIENE REF CON DIVISA DESEADA
                    -- SE COMPRUEBA SALDO SUFICIENTE
                    -- CUENTA_REFERENCIA SÃ? ES NECESARIO BLOQUEARLA YA QUE EL SALDO SE PODRÃ?A MODIFICAR DURANTE TRANSACCIÃN
                    SELECT SALDO INTO P_SALDO FROM CUENTA_REFERENCIA WHERE CUENTA_CUENTA_ID = REF_AUX FOR UPDATE;
                    IF P_SALDO < IMPORTE THEN
                        RAISE SALDO_INSUFICIENTE_EXCEPTION;
                    END IF;
                    --  REDUCIR SALDO
                    UPDATE CUENTA_REFERENCIA SET SALDO = SALDO - IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                    UPDATE DEPOSITAR_EN SET SALDO = SALDO - IMPORTE WHERE CUENTA_REF_ID = REF_AUX AND POOL_ID = FINTECH;
                END IF;

            END IF;

            -- CREAR CUENTA EXTERNA NO REGISTRADA
            CUENTA_2 := SQ_CUENTA.NEXTVAL;
            INSERT INTO CUENTA VALUES (CUENTA_2, IBAN_2, NULL); -- ID BY SEQUENCE SWIFT IS NULL

        ELSE -- TODAS LAS CUENTAS ESTÃ?N REGISTRADAS
            
             -- SE COMPRUEBA QUE ALGUNA CUENTA SEA FINTECH
            SELECT CUENTA_CUENTA_ID INTO CUENTA_1 FROM CUENTA_FINTECH WHERE CUENTA_CUENTA_ID = CUENTA_1;
            SELECT CUENTA_CUENTA_ID INTO CUENTA_2 FROM CUENTA_FINTECH WHERE CUENTA_CUENTA_ID = CUENTA_2;

            IF CUENTA_1 IS NULL AND CUENTA_2 IS NULL THEN -- NINGUNA CUENTA ES FINTECH -> EXCEPTION
                RAISE NO_CUENTA_FINTECH_EXCEPTION;
            ELSIF CUENTA_1 IS NULL THEN -- CUENTA_1 ES EXTERNA EN BD
            
                -- SE COMPRUEBA QUE SEA SEGREGADA O POOLED
                SELECT CUENTA_FINTECH_ID INTO FINTECH FROM POOLED_ACCOUNT WHERE CUENTA_FINTECH_ID = CUENTA_2;
                IF FINTECH IS NULL THEN

                    SELECT CUENTA_FINTECH_ID INTO FINTECH FROM SEGREGADA WHERE CUENTA_FINTECH_ID = CUENTA_2;
                    IF FINTECH IS NULL THEN -- NO ES NI POOLED NI SEGREGADA -> EXCEPTION
                        RAISE NO_CUENTA_FINTECH_EXCEPTION;
                    ELSE -- LA CUENTA FINTECH ES SEGREGADA

                        -- SE COMPRUEBA QUE LAS DIVISAS COINCIDAN Y SE GUARDA ID DE CUENTA_REFERENCIA
                        SELECT DIVISA_ABREVIATURA, CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA
                        JOIN SEGREGADA ON SEGREGADA.CUENTA_REF_ID = CUENTA_REFERENCIA.CUENTA_CUENTA_ID
                        WHERE SEGREGADA.CUENTA_FINTECH_ID = FINTECH
                        FOR UPDATE;

                        IF DIVISA_R <> P_DIVISA_ABREVIATURA2 THEN -- DIVISAS NO COINCIDEN -> EXCEPTION
                            RAISE SEGREGADA_DIVISA_NOT_MATCH;
                        END IF;

                        -- AUMENTAR SALDO
                        UPDATE CUENTA_REFERENCIA SET SALDO = SALDO + IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                    END IF;
                ELSE -- LA CUENTA ES POOLED

                    -- SE BUSCA LA DIVISA DESEADA EN LA POOLED, SI NO SE ENCUENTRA SE CREA
                    SELECT CR.DIVISA_ABREVIATURA, CR.CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA CR
                    JOIN DEPOSITAR_EN D ON D.CUENTA_REF_ID = CR.CUENTA_CUENTA_ID
                    JOIN POOLED_ACCOUNT P ON P.CUENTA_FINTECH_ID = D.POOL_ID
                    WHERE P.CUENTA_FINTECH_ID = FINTECH
                    AND CR.DIVISA_ABREVIATURA LIKE P_DIVISA_ABREVIATURA2
                    FOR UPDATE;

                    IF DIVISA_R IS NULL OR REF_AUX IS NULL THEN -- DIVISA NOT FOUND -> CREAR CUENTA_REF CON DIVISA
                        REF_AUX := SQ_CUENTA.NEXTVAL;
                        -- ID BY SEQUENCE, BANCO: DEFAULT, SALDO INICIADO CON CANTIDAD DE TRANSACCION
                        INSERT INTO CUENTA_REFERENCIA VALUES (REF_AUX, 'DEFAULT', NULL, NULL, IMPORTE, SYSDATE, 'ACTIVO', P_DIVISA_ABREVIATURA2);
                        -- SE ASIGNA A LA CUENTA POOLED LA NUEVA CUENTA REFERENCIA CON EL SALDO DE LA TRANSACCION
                        INSERT INTO DEPOSITAR_EN VALUES (IMPORTE, REF_AUX, FINTECH);
                    ELSE -- CUENTA POOLED YA TIENE REF CON DIVISA DESEADA
                        -- AGREGAR TRANSACCION A SALDO
                        UPDATE CUENTA_REFERENCIA SET SALDO = SALDO + IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                        UPDATE DEPOSITAR_EN SET SALDO = SALDO + IMPORTE WHERE CUENTA_REF_ID = REF_AUX AND POOL_ID = FINTECH;
                    END IF;

                END IF;
            ELSIF CUENTA_2 IS NULL THEN -- CUENTA_2 ES EXTERNA EN BD

                -- SE COMPRUEBA QUE LA OTRA CUENTA SEA FINTECH
                SELECT CUENTA_CUENTA_ID INTO CUENTA_1 FROM CUENTA_FINTECH WHERE CUENTA_CUENTA_ID = CUENTA_1;
                IF CUENTA_1 IS NULL THEN
                    RAISE NO_CUENTA_FINTECH_EXCEPTION;
                END IF;
                
                -- SE COMPRUEBA QUE SEA SEGREGADA O POOLED
                SELECT CUENTA_FINTECH_ID INTO FINTECH FROM POOLED_ACCOUNT WHERE CUENTA_FINTECH_ID = CUENTA_1;
                IF FINTECH IS NULL THEN

                    SELECT CUENTA_FINTECH_ID INTO FINTECH FROM SEGREGADA WHERE CUENTA_FINTECH_ID = CUENTA_1;
                    IF FINTECH IS NULL THEN -- NO ES NI POOLED NI SEGREGADA -> EXCEPTION
                        RAISE NO_CUENTA_FINTECH_EXCEPTION;
                    ELSE -- LA CUENTA FINTECH ES SEGREGADA

                        -- SE COMPRUEBA QUE LAS DIVISAS COINCIDAN Y SE GUARDA ID DE CUENTA_REFERENCIA
                        SELECT DIVISA_ABREVIATURA, CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA
                        JOIN SEGREGADA ON SEGREGADA.CUENTA_REF_ID = CUENTA_REFERENCIA.CUENTA_CUENTA_ID
                        WHERE SEGREGADA.CUENTA_FINTECH_ID = FINTECH;

                        IF DIVISA_R <> P_DIVISA_ABREVIATURA THEN -- DIVISAS NO COINCIDEN -> EXCEPTION
                            RAISE SEGREGADA_DIVISA_NOT_MATCH;
                        END IF;

                        -- COMPROBAR SALDO SUFICIENTE
                        -- CUENTA_REFERENCIA SÃ? ES NECESARIO BLOQUEARLA YA QUE EL SALDO SE PODRÃ?A MODIFICAR DURANTE TRANSACCIÃN
                        SELECT SALDO INTO P_SALDO FROM CUENTA_REFERENCIA WHERE CUENTA_CUENTA_ID = REF_AUX FOR UPDATE;
                        IF P_SALDO < IMPORTE THEN
                            RAISE SALDO_INSUFICIENTE_EXCEPTION;
                        END IF;

                        -- REDUCIR SALDO
                        UPDATE CUENTA_REFERENCIA SET SALDO = SALDO - IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                    END IF;
                ELSE -- LA CUENTA FINTECH ES POOLED

                    -- SE BUSCA LA DIVISA DESEADA EN LA POOLED, SI NO SE ENCUENTRA SE CREA
                    -- SE ASUME QUE SOLO EXISTE UNA CUENTA REFERENCIA POR DIVISA --
                    SELECT CR.DIVISA_ABREVIATURA, CR.CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA CR
                    JOIN DEPOSITAR_EN D ON D.CUENTA_REF_ID = CR.CUENTA_CUENTA_ID
                    JOIN POOLED_ACCOUNT P ON P.CUENTA_FINTECH_ID = D.POOL_ID
                    WHERE P.CUENTA_FINTECH_ID = FINTECH
                    AND CR.DIVISA_ABREVIATURA LIKE P_DIVISA_ABREVIATURA
                    FOR UPDATE;

                    IF DIVISA_R IS NULL OR REF_AUX IS NULL THEN -- DIVISA NOT FOUND -> EXCEPTION
                        -- NO SE PUEDE CREAR UNA NUEVA CUENTA REFERENCIA YA QUE EL SALDO SERÃ?A 0
                        -- AQUÃ? LA CUENTA POOLED ES LA EMISORA DE LA TRANSACCIÃN LUEGO EL SALDO NO PUEDE SER 0
                        RAISE DIVISA_NOT_FOUND_EXCEPTION;
                    ELSE -- CUENTA POOLED YA TIENE REF CON DIVISA DESEADA
                        -- SE COMPRUEBA SALDO SUFICIENTE
                        -- CUENTA_REFERENCIA SÃ? ES NECESARIO BLOQUEARLA YA QUE EL SALDO SE PODRÃ?A MODIFICAR DURANTE TRANSACCIÃN
                        SELECT SALDO INTO P_SALDO FROM CUENTA_REFERENCIA WHERE CUENTA_CUENTA_ID = REF_AUX FOR UPDATE;
                        IF P_SALDO < IMPORTE THEN
                            RAISE SALDO_INSUFICIENTE_EXCEPTION;
                        END IF;
                        --  REDUCIR SALDO
                        UPDATE CUENTA_REFERENCIA SET SALDO = SALDO - IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                        UPDATE DEPOSITAR_EN SET SALDO = SALDO - IMPORTE WHERE CUENTA_REF_ID = REF_AUX AND POOL_ID = FINTECH;
                    END IF;

                END IF;

            ELSE -- NINGUNA CUENTA ES EXTERNA
                
                -- CUENTA_1
                -- SE COMPRUEBA QUE SEA SEGREGADA O POOLED
                SELECT CUENTA_FINTECH_ID INTO FINTECH FROM POOLED_ACCOUNT WHERE CUENTA_FINTECH_ID = CUENTA_1;
                IF FINTECH IS NULL THEN

                    SELECT CUENTA_FINTECH_ID INTO FINTECH FROM SEGREGADA WHERE CUENTA_FINTECH_ID = CUENTA_1;
                    IF FINTECH IS NULL THEN -- NO ES NI POOLED NI SEGREGADA -> EXCEPTION
                        RAISE NO_CUENTA_FINTECH_EXCEPTION;
                    ELSE -- LA CUENTA FINTECH ES SEGREGADA

                        -- SE COMPRUEBA QUE LAS DIVISAS COINCIDAN Y SE GUARDA ID DE CUENTA_REFERENCIA
                        SELECT DIVISA_ABREVIATURA, CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA
                        JOIN SEGREGADA ON SEGREGADA.CUENTA_REF_ID = CUENTA_REFERENCIA.CUENTA_CUENTA_ID
                        WHERE SEGREGADA.CUENTA_FINTECH_ID = FINTECH;

                        IF DIVISA_R <> P_DIVISA_ABREVIATURA THEN -- DIVISAS NO COINCIDEN -> EXCEPTION
                            RAISE SEGREGADA_DIVISA_NOT_MATCH;
                        END IF;

                        -- COMPROBAR SALDO SUFICIENTE
                        -- CUENTA_REFERENCIA SÃ? ES NECESARIO BLOQUEARLA YA QUE EL SALDO SE PODRÃ?A MODIFICAR DURANTE TRANSACCIÃN
                        SELECT SALDO INTO P_SALDO FROM CUENTA_REFERENCIA WHERE CUENTA_CUENTA_ID = REF_AUX FOR UPDATE;
                        IF P_SALDO < IMPORTE THEN
                            RAISE SALDO_INSUFICIENTE_EXCEPTION;
                        END IF;

                        -- REDUCIR SALDO
                        UPDATE CUENTA_REFERENCIA SET SALDO = SALDO - IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                    END IF;
                ELSE -- LA CUENTA FINTECH ES POOLED

                    -- SE BUSCA LA DIVISA DESEADA EN LA POOLED, SI NO SE ENCUENTRA SE CREA
                    -- SE ASUME QUE SOLO EXISTE UNA CUENTA REFERENCIA POR DIVISA --
                    SELECT CR.DIVISA_ABREVIATURA, CR.CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA CR
                    JOIN DEPOSITAR_EN D ON D.CUENTA_REF_ID = CR.CUENTA_CUENTA_ID
                    JOIN POOLED_ACCOUNT P ON P.CUENTA_FINTECH_ID = D.POOL_ID
                    WHERE P.CUENTA_FINTECH_ID = FINTECH
                    AND CR.DIVISA_ABREVIATURA LIKE P_DIVISA_ABREVIATURA
                    FOR UPDATE;

                    IF DIVISA_R IS NULL OR REF_AUX IS NULL THEN -- DIVISA NOT FOUND -> EXCEPTION
                        -- NO SE PUEDE CREAR UNA NUEVA CUENTA REFERENCIA YA QUE EL SALDO SERÃ?A 0
                        -- AQUÃ? LA CUENTA POOLED ES LA EMISORA DE LA TRANSACCIÃN LUEGO EL SALDO NO PUEDE SER 0
                        RAISE DIVISA_NOT_FOUND_EXCEPTION;
                    ELSE -- CUENTA POOLED YA TIENE REF CON DIVISA DESEADA
                        -- SE COMPRUEBA SALDO SUFICIENTE
                        -- CUENTA_REFERENCIA SÃ? ES NECESARIO BLOQUEARLA YA QUE EL SALDO SE PODRÃ?A MODIFICAR DURANTE TRANSACCIÃN
                        SELECT SALDO INTO P_SALDO FROM CUENTA_REFERENCIA WHERE CUENTA_CUENTA_ID = REF_AUX FOR UPDATE;
                        IF P_SALDO < IMPORTE THEN
                            RAISE SALDO_INSUFICIENTE_EXCEPTION;
                        END IF;
                        --  REDUCIR SALDO
                        UPDATE CUENTA_REFERENCIA SET SALDO = SALDO - IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                        UPDATE DEPOSITAR_EN SET SALDO = SALDO - IMPORTE WHERE CUENTA_REF_ID = REF_AUX AND POOL_ID = FINTECH;
                    END IF;
                END IF;

                -- CUENTA_2
                -- SE COMPRUEBA QUE SEA SEGREGADA O POOLED
                SELECT CUENTA_FINTECH_ID INTO FINTECH FROM POOLED_ACCOUNT WHERE CUENTA_FINTECH_ID = CUENTA_2;
                IF FINTECH IS NULL THEN

                    SELECT CUENTA_FINTECH_ID INTO FINTECH FROM SEGREGADA WHERE CUENTA_FINTECH_ID = CUENTA_2;
                    IF FINTECH IS NULL THEN -- NO ES NI POOLED NI SEGREGADA -> EXCEPTION
                        RAISE NO_CUENTA_FINTECH_EXCEPTION;
                    ELSE -- LA CUENTA FINTECH ES SEGREGADA

                        -- SE COMPRUEBA QUE LAS DIVISAS COINCIDAN Y SE GUARDA ID DE CUENTA_REFERENCIA
                        SELECT DIVISA_ABREVIATURA, CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA
                        JOIN SEGREGADA ON SEGREGADA.CUENTA_REF_ID = CUENTA_REFERENCIA.CUENTA_CUENTA_ID
                        WHERE SEGREGADA.CUENTA_FINTECH_ID = FINTECH
                        FOR UPDATE;

                        IF DIVISA_R <> P_DIVISA_ABREVIATURA2 THEN -- DIVISAS NO COINCIDEN -> EXCEPTION
                            RAISE SEGREGADA_DIVISA_NOT_MATCH;
                        END IF;

                        -- AUMENTAR SALDO
                        UPDATE CUENTA_REFERENCIA SET SALDO = SALDO + IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                    END IF;
                ELSE -- LA CUENTA ES POOLED

                    -- SE BUSCA LA DIVISA DESEADA EN LA POOLED, SI NO SE ENCUENTRA SE CREA
                    SELECT CR.DIVISA_ABREVIATURA, CR.CUENTA_CUENTA_ID INTO DIVISA_R, REF_AUX FROM CUENTA_REFERENCIA CR
                    JOIN DEPOSITAR_EN D ON D.CUENTA_REF_ID = CR.CUENTA_CUENTA_ID
                    JOIN POOLED_ACCOUNT P ON P.CUENTA_FINTECH_ID = D.POOL_ID
                    WHERE P.CUENTA_FINTECH_ID = FINTECH
                    AND CR.DIVISA_ABREVIATURA LIKE P_DIVISA_ABREVIATURA2
                    FOR UPDATE;

                    IF DIVISA_R IS NULL OR REF_AUX IS NULL THEN -- DIVISA NOT FOUND -> CREAR CUENTA_REF CON DIVISA
                        REF_AUX := SQ_CUENTA.NEXTVAL;
                        -- ID BY SEQUENCE, BANCO: DEFAULT, SALDO INICIADO CON CANTIDAD DE TRANSACCION
                        INSERT INTO CUENTA_REFERENCIA VALUES (REF_AUX, 'DEFAULT', NULL, NULL, IMPORTE, SYSDATE, 'ACTIVO', P_DIVISA_ABREVIATURA2);
                        -- SE ASIGNA A LA CUENTA POOLED LA NUEVA CUENTA REFERENCIA CON EL SALDO DE LA TRANSACCION
                        INSERT INTO DEPOSITAR_EN VALUES (IMPORTE, REF_AUX, FINTECH);
                    ELSE -- CUENTA POOLED YA TIENE REF CON DIVISA DESEADA
                        -- AGREGAR TRANSACCION A SALDO
                        UPDATE CUENTA_REFERENCIA SET SALDO = SALDO + IMPORTE WHERE CUENTA_CUENTA_ID = REF_AUX;
                        UPDATE DEPOSITAR_EN SET SALDO = SALDO + IMPORTE WHERE CUENTA_REF_ID = REF_AUX AND POOL_ID = FINTECH;
                    END IF;

                END IF;

            END IF;

        END IF;

        -- CREAR TRANSACCION
        INSERT INTO TRANSACCION VALUES (1, P_FECHA, P_CANTIDAD, SYSDATE, P_TIPO, P_COMISION, 
            P_INTERNACIONAL, P_DIVISA_ABREVIATURA, P_DIVISA_ABREVIATURA2, CUENTA_1, CUENTA_2);

        -- COMMIT
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
    END; 
    
    PROCEDURE CAMBIO_DIVISAS(
    P_IBAN              IN CUENTA.IBAN%TYPE,
    P_CANTIDAD          IN TRANSACCION.CANTIDAD%TYPE,
    P_DIVISA_ORIGEN     IN DIVISA.ABREVIATURA%TYPE,
    P_DIVISA_OBJETIVO   IN DIVISA.ABREVIATURA%TYPE
    )
    IS
    -- VARIABLES
    CUENTA_AUX POOLED_ACCOUNT.CUENTA_FINTECH_ID%TYPE;
    DIVISA_AUX DIVISA.ABREVIATURA%TYPE;
    BEGIN
        SELECT CUENTA_ID INTO CUENTA_AUX FROM CUENTA WHERE IBAN LIKE P_IBAN;
        IF CUENTA_AUX IS NULL THEN -- CUENTA NO SE ENCUENTRA EN BD -> EXCEPTION
            RAISE CUENTA_NOT_FOUND_EXCEPTION;
        END IF;
        SELECT CUENTA_CUENTA_ID INTO CUENTA_AUX FROM CUENTA_FINTECH WHERE CUENTA_CUENTA_ID = CUENTA_AUX;
        IF CUENTA_AUX IS NULL THEN -- CUENTA NO SE ENCUENTRA EN BD -> EXCEPTION
            RAISE NO_CUENTA_FINTECH_EXCEPTION;
        END IF;
        SELECT ABREVIATURA INTO DIVISA_AUX FROM DIVISA WHERE ABREVIATURA = P_DIVISA_ORIGEN;
        IF DIVISA_AUX IS NULL THEN -- DIVISA NO SE ENCUENTRA EN BD -> EXCEPTION
            RAISE DIVISA_NOT_FOUND_EXCEPTION;
        END IF;
        SELECT ABREVIATURA INTO DIVISA_AUX FROM DIVISA WHERE ABREVIATURA = P_DIVISA_OBJETIVO;
        IF DIVISA_AUX IS NULL THEN -- DIVISA NO SE ENCUENTRA EN BD -> EXCEPTION
            RAISE DIVISA_NOT_FOUND_EXCEPTION;
        END IF;

        PK_OPERATIVA.INSERTAR_TRANSACCIONES(SYSDATE, P_CANTIDAD, 'CAMBIO DIVISAS', 0, 'INTERNACIONAL', P_DIVISA_ORIGEN, P_DIVISA_OBJETIVO, P_IBAN, P_IBAN);

        -- COMMIT
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE;
    END;

END PK_OPERATIVA;

/
--------------------------------------------------------
--  DDL for Function F_COMPRUEBA_SEGREGADA
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "FINTECH"."F_COMPRUEBA_SEGREGADA" (ref_id in cuenta_referencia.cuenta_cuenta_id%type)
    RETURN BOOLEAN IS
    es_segregada BOOLEAN := false;
    segregada_asociada  segregada.cuenta_fintech_id%type;
    BEGIN
    SELECT seg.cuenta_fintech_id INTO segregada_asociada FROM segregada seg, cuenta_referencia refe
        WHERE seg.cuenta_ref_id = refe.cuenta_cuenta_id  AND
            ref_id = refe.cuenta_cuenta_id;

    IF segregada_asociada IS NOT NULL 
    THEN
        RETURN TRUE;
    ELSE
        RETURN FALSE;
    END IF;

END f_comprueba_segregada;

/
--------------------------------------------------------
--  DDL for Function F_SALDO_REFERENCIA
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "FINTECH"."F_SALDO_REFERENCIA" (ref_id in cuenta_referencia.cuenta_cuenta_id%type)
    RETURN cuenta_referencia.saldo%type IS
    saldo_aux        cuenta_referencia.saldo%type;  -- saldo inicial de la cuenta referencia
    cantidad_aux     movimientos.cantidad%type;     -- cantidad a cobrar
    pooled_aux       pooled_account.cuenta_fintech_id%type;  -- cuenta pooled de la que restar el saldo en depositar_en
    saldo_aux_depo   depositar_en.saldo%type;  -- saldo inicial de la pooled en la tabla depositar_en
        BEGIN
            IF f_comprueba_segregada(ref_id) THEN  -- el caso en que la cuenta es segregada
                SELECT m.cantidad, cref.saldo INTO cantidad_aux, saldo_aux 
                FROM cuenta_referencia cref, movimientos m, segregada seg, cuenta_fintech cf, cuenta, tarjetas tar
                    WHERE cref.cuenta_cuenta_id = ref_id  AND
                        seg.cuenta_ref_id = cref.cuenta_cuenta_id AND
                        cf.cuenta_cuenta_id = seg.cuenta_fintech_id AND
                        cuenta.cuenta_id = cf.cuenta_cuenta_id AND
                        tar.cuenta_fintech_id = cf.cuenta_cuenta_id AND
                        m.numero_tarjeta = tar.numero;
                RETURN saldo_aux - cantidad_aux;

            ELSE  -- el caso en que la cuenta es pooled
                SELECT movi.cantidad, c.saldo, pc.cuenta_fintech_id, depo.saldo INTO cantidad_aux, saldo_aux, pooled_aux, saldo_aux_depo
                FROM cuenta_referencia c, movimientos movi, depositar_en depo, pooled_account pc, cuenta_fintech cf, cuenta, tarjetas tar
                    WHERE c.cuenta_cuenta_id = ref_id  AND
                        c.cuenta_cuenta_id = depo.cuenta_ref_id AND
                        pc.cuenta_fintech_id = depo.pool_id AND
                        pc.cuenta_fintech_id = cf.cuenta_cuenta_id AND
                        cuenta.cuenta_id = cf.cuenta_cuenta_id AND
                        tar.cuenta_fintech_id = cf.cuenta_cuenta_id AND
                        movi.numero_tarjeta = tar.numero;

                UPDATE DEPOSITAR_EN
                    SET 
                        SALDO = saldo_aux_depo - cantidad_aux
                    WHERE
                        pooled_aux = pool_id AND
                        ref_id = cuenta_ref_id;

                RETURN saldo_aux - cantidad_aux;

            END IF;
END f_saldo_referencia;

/
--------------------------------------------------------
--  DDL for Synonymn COTIZACION
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE SYNONYM "FINTECH"."COTIZACION" FOR "FINTECH"."VM_COTIZA";
--------------------------------------------------------
--  Constraints for Table AUTORIZACION
--------------------------------------------------------

  ALTER TABLE "FINTECH"."AUTORIZACION" MODIFY ("TIPO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."AUTORIZACION" MODIFY ("PERSONA_AUTORIZADA_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."AUTORIZACION" MODIFY ("EMPRESA_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."AUTORIZACION" ADD CONSTRAINT "AUTORIZACION_PK" PRIMARY KEY ("PERSONA_AUTORIZADA_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table CLIENTE
--------------------------------------------------------

  ALTER TABLE "FINTECH"."CLIENTE" ADD CONSTRAINT "CLIENTE_IDENTIFICACION_UN" UNIQUE ("IDENTIFICACION")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("IDENTIFICACION" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("TIPO_CLIENTE" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("ESTADO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("FECHA_ALTA" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("DIRECCION" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("CIUDAD" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("CODIGO_POSTAL" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" MODIFY ("PAIS" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CLIENTE" ADD CONSTRAINT "CLIENTE_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table CUENTA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."CUENTA" MODIFY ("CUENTA_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA" MODIFY ("IBAN" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA" ADD CONSTRAINT "CUENTA_PK" PRIMARY KEY ("CUENTA_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table CUENTA_FINTECH
--------------------------------------------------------

  ALTER TABLE "FINTECH"."CUENTA_FINTECH" MODIFY ("CUENTA_CUENTA_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA_FINTECH" MODIFY ("CLIENTE_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA_FINTECH" MODIFY ("ESTADO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA_FINTECH" MODIFY ("FECHA_APERTURA" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA_FINTECH" ADD CONSTRAINT "CUENTA_FINTECH_PK" PRIMARY KEY ("CUENTA_CUENTA_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table CUENTA_REFERENCIA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."CUENTA_REFERENCIA" MODIFY ("CUENTA_CUENTA_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA_REFERENCIA" MODIFY ("NOMBRE_BANCO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA_REFERENCIA" MODIFY ("SALDO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA_REFERENCIA" MODIFY ("DIVISA_ABREVIATURA" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."CUENTA_REFERENCIA" ADD CONSTRAINT "CUENTA_REFERENCIA_PK" PRIMARY KEY ("CUENTA_CUENTA_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table DEPOSITAR_EN
--------------------------------------------------------

  ALTER TABLE "FINTECH"."DEPOSITAR_EN" MODIFY ("SALDO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."DEPOSITAR_EN" MODIFY ("CUENTA_REF_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."DEPOSITAR_EN" MODIFY ("POOL_ID" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table DIVISA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."DIVISA" MODIFY ("ABREVIATURA" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."DIVISA" MODIFY ("NOMBRE" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."DIVISA" MODIFY ("CAMBIO_EURO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."DIVISA" ADD CONSTRAINT "DIVISA_PK" PRIMARY KEY ("ABREVIATURA")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table EMPRESA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."EMPRESA" MODIFY ("CLIENTE_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."EMPRESA" MODIFY ("RAZON_SOCIAL" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."EMPRESA" ADD CONSTRAINT "EMPRESA_PK" PRIMARY KEY ("CLIENTE_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table INDIVIDUAL
--------------------------------------------------------

  ALTER TABLE "FINTECH"."INDIVIDUAL" MODIFY ("CLIENTE_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."INDIVIDUAL" MODIFY ("NOMBRE" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."INDIVIDUAL" MODIFY ("APELLIDO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."INDIVIDUAL" ADD CONSTRAINT "INDIVIDUAL_PK" PRIMARY KEY ("CLIENTE_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table MOVIMIENTOS
--------------------------------------------------------

  ALTER TABLE "FINTECH"."MOVIMIENTOS" MODIFY ("NUMERO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."MOVIMIENTOS" MODIFY ("NUMERO_TARJETA" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."MOVIMIENTOS" MODIFY ("FECHA" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."MOVIMIENTOS" MODIFY ("ESTADO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."MOVIMIENTOS" ADD CONSTRAINT "MOVIMIENTOS_PK" PRIMARY KEY ("NUMERO")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table PERSONA_AUTORIZADA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."PERSONA_AUTORIZADA" MODIFY ("ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."PERSONA_AUTORIZADA" MODIFY ("IDENTIFICACION" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."PERSONA_AUTORIZADA" MODIFY ("NOMBRE" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."PERSONA_AUTORIZADA" MODIFY ("APELLIDOS" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."PERSONA_AUTORIZADA" MODIFY ("DIRECCION" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."PERSONA_AUTORIZADA" ADD CONSTRAINT "PERSONA_AUTORIZADA_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
  ALTER TABLE "FINTECH"."PERSONA_AUTORIZADA" ADD CONSTRAINT "PERSONA_AUTORIZADA_ID_UN" UNIQUE ("IDENTIFICACION")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table POOLED_ACCOUNT
--------------------------------------------------------

  ALTER TABLE "FINTECH"."POOLED_ACCOUNT" MODIFY ("CUENTA_FINTECH_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."POOLED_ACCOUNT" ADD CONSTRAINT "POOLED_ACCOUNT_PK" PRIMARY KEY ("CUENTA_FINTECH_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table SEGREGADA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."SEGREGADA" MODIFY ("CUENTA_FINTECH_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."SEGREGADA" MODIFY ("CUENTA_REF_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."SEGREGADA" ADD CONSTRAINT "SEGREGADA_PK" PRIMARY KEY ("CUENTA_FINTECH_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table TARJETAS
--------------------------------------------------------

  ALTER TABLE "FINTECH"."TARJETAS" MODIFY ("NUMERO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TARJETAS" MODIFY ("NOMBRE_TITULAR" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TARJETAS" MODIFY ("CVV" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TARJETAS" MODIFY ("MARCA" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TARJETAS" MODIFY ("FECHA_CAD" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TARJETAS" MODIFY ("CLIENTE_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TARJETAS" MODIFY ("CUENTA_FINTECH_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TARJETAS" ADD CONSTRAINT "TARJETAS_PK" PRIMARY KEY ("NUMERO")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Constraints for Table TRANSACCION
--------------------------------------------------------

  ALTER TABLE "FINTECH"."TRANSACCION" MODIFY ("ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TRANSACCION" MODIFY ("FECHA_INSTRUCCION" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TRANSACCION" MODIFY ("TIPO" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TRANSACCION" MODIFY ("DIVISA_ABREVIATURA2" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TRANSACCION" MODIFY ("DIVISA_ABREVIATURA" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TRANSACCION" MODIFY ("CUENTA_CUENTA_ID" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TRANSACCION" MODIFY ("CUENTA_CUENTA_ID1" NOT NULL ENABLE);
  ALTER TABLE "FINTECH"."TRANSACCION" ADD CONSTRAINT "TRANSACCION_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TS_FINTECH"  ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table AUTORIZACION
--------------------------------------------------------

  ALTER TABLE "FINTECH"."AUTORIZACION" ADD CONSTRAINT "AUTORIZACION_EMPRESA_FK" FOREIGN KEY ("EMPRESA_ID")
	  REFERENCES "FINTECH"."EMPRESA" ("CLIENTE_ID") ENABLE;
  ALTER TABLE "FINTECH"."AUTORIZACION" ADD CONSTRAINT "AUTORIZACION_PERS_AUTRZDA_FK" FOREIGN KEY ("PERSONA_AUTORIZADA_ID")
	  REFERENCES "FINTECH"."PERSONA_AUTORIZADA" ("ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table CUENTA_FINTECH
--------------------------------------------------------

  ALTER TABLE "FINTECH"."CUENTA_FINTECH" ADD CONSTRAINT "CUENTA_FINTECH_CLIENTE_FK" FOREIGN KEY ("CLIENTE_ID")
	  REFERENCES "FINTECH"."CLIENTE" ("ID") ENABLE;
  ALTER TABLE "FINTECH"."CUENTA_FINTECH" ADD CONSTRAINT "CUENTA_FINTECH_CUENTA_FK" FOREIGN KEY ("CUENTA_CUENTA_ID")
	  REFERENCES "FINTECH"."CUENTA" ("CUENTA_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table CUENTA_REFERENCIA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."CUENTA_REFERENCIA" ADD CONSTRAINT "CUENTA_REFERENCIA_CUENTA_FK" FOREIGN KEY ("CUENTA_CUENTA_ID")
	  REFERENCES "FINTECH"."CUENTA" ("CUENTA_ID") ENABLE;
  ALTER TABLE "FINTECH"."CUENTA_REFERENCIA" ADD CONSTRAINT "CUENTA_REFERENCIA_DIVISA_FK" FOREIGN KEY ("DIVISA_ABREVIATURA")
	  REFERENCES "FINTECH"."DIVISA" ("ABREVIATURA") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table DEPOSITAR_EN
--------------------------------------------------------

  ALTER TABLE "FINTECH"."DEPOSITAR_EN" ADD CONSTRAINT "DEPOSITAR_EN_CUENTA_REF_FK" FOREIGN KEY ("CUENTA_REF_ID")
	  REFERENCES "FINTECH"."CUENTA_REFERENCIA" ("CUENTA_CUENTA_ID") ENABLE;
  ALTER TABLE "FINTECH"."DEPOSITAR_EN" ADD CONSTRAINT "DEPOSITAR_EN_POOL_ACC_FK" FOREIGN KEY ("POOL_ID")
	  REFERENCES "FINTECH"."POOLED_ACCOUNT" ("CUENTA_FINTECH_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table EMPRESA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."EMPRESA" ADD CONSTRAINT "EMPRESA_CLIENTE_FK" FOREIGN KEY ("CLIENTE_ID")
	  REFERENCES "FINTECH"."CLIENTE" ("ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table INDIVIDUAL
--------------------------------------------------------

  ALTER TABLE "FINTECH"."INDIVIDUAL" ADD CONSTRAINT "INDIVIDUAL_CLIENTE_FK" FOREIGN KEY ("CLIENTE_ID")
	  REFERENCES "FINTECH"."CLIENTE" ("ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table MOVIMIENTOS
--------------------------------------------------------

  ALTER TABLE "FINTECH"."MOVIMIENTOS" ADD CONSTRAINT "TARJETA_FK" FOREIGN KEY ("NUMERO_TARJETA")
	  REFERENCES "FINTECH"."TARJETAS" ("NUMERO") ENABLE;
  ALTER TABLE "FINTECH"."MOVIMIENTOS" ADD CONSTRAINT "DIVISA_FK" FOREIGN KEY ("DIVISA")
	  REFERENCES "FINTECH"."DIVISA" ("ABREVIATURA") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table POOLED_ACCOUNT
--------------------------------------------------------

  ALTER TABLE "FINTECH"."POOLED_ACCOUNT" ADD CONSTRAINT "POOL_ACC_CUENTA_FT_FK" FOREIGN KEY ("CUENTA_FINTECH_ID")
	  REFERENCES "FINTECH"."CUENTA_FINTECH" ("CUENTA_CUENTA_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table SEGREGADA
--------------------------------------------------------

  ALTER TABLE "FINTECH"."SEGREGADA" ADD CONSTRAINT "SEGREGADA_CUENTA_FINTECH_FK" FOREIGN KEY ("CUENTA_FINTECH_ID")
	  REFERENCES "FINTECH"."CUENTA_FINTECH" ("CUENTA_CUENTA_ID") ENABLE;
  ALTER TABLE "FINTECH"."SEGREGADA" ADD CONSTRAINT "SEGREGADA_CUENTA_REFERENCIA_FK" FOREIGN KEY ("CUENTA_REF_ID")
	  REFERENCES "FINTECH"."CUENTA_REFERENCIA" ("CUENTA_CUENTA_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table TARJETAS
--------------------------------------------------------

  ALTER TABLE "FINTECH"."TARJETAS" ADD CONSTRAINT "TARJETAS_CLIENTE_FK" FOREIGN KEY ("CLIENTE_ID")
	  REFERENCES "FINTECH"."CLIENTE" ("ID") ENABLE;
  ALTER TABLE "FINTECH"."TARJETAS" ADD CONSTRAINT "TARJETAS_CUENTA_FINTECH_FK" FOREIGN KEY ("CUENTA_FINTECH_ID")
	  REFERENCES "FINTECH"."CUENTA_FINTECH" ("CUENTA_CUENTA_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table TRANSACCION
--------------------------------------------------------

  ALTER TABLE "FINTECH"."TRANSACCION" ADD CONSTRAINT "TRANSACCION_CUENTA_FK" FOREIGN KEY ("CUENTA_CUENTA_ID")
	  REFERENCES "FINTECH"."CUENTA" ("CUENTA_ID") ENABLE;
  ALTER TABLE "FINTECH"."TRANSACCION" ADD CONSTRAINT "TRANSACCION_CUENTA_FKV2" FOREIGN KEY ("CUENTA_CUENTA_ID1")
	  REFERENCES "FINTECH"."CUENTA" ("CUENTA_ID") ENABLE;
  ALTER TABLE "FINTECH"."TRANSACCION" ADD CONSTRAINT "TRANSACCION_DIVISA_FK" FOREIGN KEY ("DIVISA_ABREVIATURA")
	  REFERENCES "FINTECH"."DIVISA" ("ABREVIATURA") ENABLE;
  ALTER TABLE "FINTECH"."TRANSACCION" ADD CONSTRAINT "TRANSACCION_DIVISA_FKV2" FOREIGN KEY ("DIVISA_ABREVIATURA2")
	  REFERENCES "FINTECH"."DIVISA" ("ABREVIATURA") ENABLE;
